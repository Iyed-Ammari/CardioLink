{% extends 'dashboard/base_dashboard.html.twig' %}

{% block body %}
<div style="max-width:900px; margin:40px auto;">

    <h2>üìà √âvolution Pr√©dite ‚Äî {{ dossier.user.nom }} {{ dossier.user.prenom }}</h2>
    <p style="color:#6B7280; margin-bottom:30px;">
        Pr√©diction par R√©gression Logistique sur 6 mois
    </p>

    {% if error %}
        <div style="background:#fee2e2; color:red; padding:15px; border-radius:12px;">
            ‚ö†Ô∏è {{ error }}
        </div>

    {% elseif prediction %}

        {# Risque actuel #}
        <div style="background:#fff; border-radius:16px; padding:25px; box-shadow:0 4px 15px rgba(0,0,0,0.08); margin-bottom:20px; text-align:center;">
            <h3>Risque Actuel</h3>
            <div style="font-size:56px; font-weight:800; color:
                {{ prediction.risqueActuel == 'CRITIQUE' ? '#dc2626' :
                   prediction.risqueActuel == '√âLEV√â' ? '#ea580c' :
                   prediction.risqueActuel == 'MOD√âR√â' ? '#ca8a04' : '#16a34a' }};">
                {{ prediction.probabiliteActuelle }}%
            </div>
            <div style="font-size:20px; font-weight:700;">
                {{ prediction.risqueActuel }}
            </div>
        </div>

        {# Graphique √©volution #}
        <div style="background:#fff; border-radius:16px; padding:25px; box-shadow:0 4px 15px rgba(0,0,0,0.08); margin-bottom:20px;">
            <h3 style="margin-bottom:15px;">üìä Courbe d'√©volution sur 6 mois</h3>
            <canvas id="evolutionChart" height="80"></canvas>
        </div>

        {# Tableau √©volution #}
        <div style="background:#fff; border-radius:16px; padding:25px; box-shadow:0 4px 15px rgba(0,0,0,0.08); margin-bottom:20px;">
            <h3 style="margin-bottom:15px;">üìã D√©tail mois par mois</h3>
            <table style="width:100%; border-collapse:collapse;">
                <tr style="background:#f9fafb;">
                    <th style="padding:12px; text-align:left;">Mois</th>
                    <th style="padding:12px; text-align:left;">IMC pr√©dit</th>
                    <th style="padding:12px; text-align:left;">Tension pr√©dite</th>
                    <th style="padding:12px; text-align:left;">Probabilit√©</th>
                    <th style="padding:12px; text-align:left;">Risque pr√©dit</th>
                </tr>
                {% for e in prediction.evolution %}
                <tr style="{{ loop.index is odd ? 'background:#f9fafb;' : '' }}">
                    <td style="padding:12px;">Mois {{ e.mois }}</td>
                    <td style="padding:12px;">{{ e.imc }}</td>
                    <td style="padding:12px;">{{ e.tension }} mmHg</td>
                    <td style="padding:12px; font-weight:700;">{{ e.probabilite }}%</td>
                    <td style="padding:12px;">
                        <span style="color:
                            {{ e.risque == 'CRITIQUE' ? '#dc2626' :
                               e.risque == '√âLEV√â' ? '#ea580c' :
                               e.risque == 'MOD√âR√â' ? '#ca8a04' : '#16a34a' }};
                            font-weight:700;">
                            {{ e.risque == 'CRITIQUE' ? 'üî¥' :
                               e.risque == '√âLEV√â' ? 'üü†' :
                               e.risque == 'MOD√âR√â' ? 'üü°' : 'üü¢' }}
                            {{ e.risque }}
                        </span>
                    </td>
                </tr>
                {% endfor %}
            </table>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script>
        const ctx = document.getElementById('evolutionChart').getContext('2d');
        const evolution = {{ prediction.evolution|json_encode|raw }};

        const labels = evolution.map(e => 'Mois ' + e.mois);
        const probabilities = evolution.map(e => e.probabilite);
        const imcData = evolution.map(e => e.imc);

        new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Probabilit√© risque (%)',
                        data: probabilities,
                        borderColor: '#F82239',
                        backgroundColor: 'rgba(248,34,57,0.1)',
                        fill: true,
                        tension: 0.4,
                        yAxisID: 'y'
                    },
                    {
                        label: 'IMC pr√©dit',
                        data: imcData,
                        borderColor: '#2F60F5',
                        backgroundColor: 'rgba(47,96,245,0.1)',
                        fill: false,
                        tension: 0.4,
                        yAxisID: 'y1'
                    }
                ]
            },
            options: {
                responsive: true,
                interaction: { mode: 'index', intersect: false },
                scales: {
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        min: 0,
                        max: 100,
                        title: { display: true, text: 'Probabilit√© (%)' }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: { display: true, text: 'IMC' }
                    }
                }
            }
        });
        </script>

    {% endif %}

    <br>
    <a href="{{ path('admin_dossier_show', {id: dossier.id}) }}"
       style="background:linear-gradient(90deg,#F82239,#2F60F5); color:#fff; padding:12px 24px; border-radius:12px; text-decoration:none; font-weight:800;">
        ‚Üê Retour au dossier
    </a>

</div>
{% endblock %}