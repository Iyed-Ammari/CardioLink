{% extends 'base.html.twig' %}

{% block title %}Liste des Rendez-vous{% endblock %}

{% block body %}
<div class="container mt-5">

    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
            <h3 class="mb-0">üìÖ Liste des Rendez-vous</h3>
        </div>

        <div class="card-body">

            {# Flash messages #}
            {% for label, messages in app.flashes %}
                {% for message in messages %}
                    <div class="alert alert-{{ label }}">
                        {{ message }}
                    </div>
                {% endfor %}
            {% endfor %}

            <table class="table table-bordered table-hover align-middle">
                <thead class="table-light">
                    <tr>
                        <th>Date & Heure</th>
                        <th>Patient</th>
                        <th>M√©decin</th>
                        <th>Type</th>
                        <th>Statut</th>
                        <th>Ordonnance</th>
                        <th>Actions RDV</th>
                    </tr>
                </thead>

                <tbody>
                {% for rdv in rendez_vous %}
                    <tr>

                        <td>{{ rdv.dateHeure ? rdv.dateHeure|date('d/m/Y H:i') : '' }}</td>

                        <td>
                            {{ rdv.patient.nom }} {{ rdv.patient.prenom }}
                        </td>

                        <td>
                            {{ rdv.medecin.nom }} {{ rdv.medecin.prenom }}
                        </td>

                        <td>{{ rdv.type }}</td>

                        {# ================= STATUT ================= #}
                        <td>
                            {% if is_granted('ROLE_MEDECIN') %}
                                <form method="post"
                                      action="{{ path('app_rdv_update_status', {'id': rdv.id}) }}">
                                    <input type="hidden"
                                           name="_token"
                                           value="{{ csrf_token('update_status' ~ rdv.id) }}">

                                    <select name="statut"
                                            class="form-select form-select-sm"
                                            onchange="this.form.submit()">

                                        <option value="En attente"
                                            {{ rdv.statut == 'En attente' ? 'selected' : '' }}>
                                            En attente
                                        </option>

                                        <option value="Confirm√©"
                                            {{ rdv.statut == 'Confirm√©' ? 'selected' : '' }}>
                                            Confirm√©
                                        </option>

                                        <option value="Annul√©"
                                            {{ rdv.statut == 'Annul√©' ? 'selected' : '' }}>
                                            Annul√©
                                        </option>

                                        <option value="Compl√©t√©"
                                            {{ rdv.statut == 'Compl√©t√©' ? 'selected' : '' }}>
                                            Compl√©t√©
                                        </option>
                                    </select>
                                </form>
                            {% else %}
                                {{ rdv.statut }}
                            {% endif %}
                        </td>

                        {# ================= ORDONNANCE ================= #}
                        <td>
                            {% if is_granted('ROLE_MEDECIN') %}

                                {% if rdv.ordonnance %}
                                    <a href="{{ path('ordonnance_show', {'id': rdv.ordonnance.id}) }}"
                                       class="btn btn-info btn-sm mb-1">
                                        Consulter
                                    </a>

                                    <a href="{{ path('ordonnance_edit', {'id': rdv.ordonnance.id}) }}"
                                       class="btn btn-warning btn-sm mb-1">
                                        Modifier
                                    </a>

                                    <form method="post"
                                          action="{{ path('ordonnance_delete', {'id': rdv.ordonnance.id}) }}"
                                          style="display:inline;">
                                        <input type="hidden"
                                               name="_token"
                                               value="{{ csrf_token('delete' ~ rdv.ordonnance.id) }}">
                                        <button class="btn btn-danger btn-sm mb-1"
                                                onclick="return confirm('Confirmer la suppression ?');">
                                            Supprimer
                                        </button>
                                    </form>

                                {% else %}
                                    <a href="{{ path('ordonnance_new', {'rdvId': rdv.id}) }}"
                                       class="btn btn-success btn-sm">
                                        Cr√©er
                                    </a>
                                {% endif %}

                            {% else %}

                                {% if rdv.ordonnance %}
                                    <a href="{{ path('ordonnance_show', {'id': rdv.ordonnance.id}) }}"
                                       class="btn btn-primary btn-sm">
                                        Consulter
                                    </a>

                                    <a href="{{ path('ordonnance_pdf', {'id': rdv.ordonnance.id}) }}"
                                       class="btn btn-secondary btn-sm">
                                        üìÑ PDF
                                    </a>
                                {% else %}
                                    ‚ùå
                                {% endif %}

                            {% endif %}
                        </td>

                        {# ================= ACTIONS RDV ================= #}
                        <td>
                            <a href="{{ path('app_rdv_edit', {'id': rdv.id}) }}"
                               class="btn btn-warning btn-sm">
                                Modifier
                            </a>

                            <form method="post"
                                  action="{{ path('app_rdv_delete', {'id': rdv.id}) }}"
                                  style="display:inline;">
                                <input type="hidden"
                                       name="_token"
                                       value="{{ csrf_token('delete' ~ rdv.id) }}">
                                <button class="btn btn-danger btn-sm"
                                        onclick="return confirm('Confirmer la suppression ?');">
                                    Supprimer
                                </button>
                            </form>
                        </td>

                    </tr>

                {% else %}
                    <tr>
                        <td colspan="7" class="text-center">
                            Aucun rendez-vous trouv√©.
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>

        </div>
    </div>
</div>
{% endblock %}