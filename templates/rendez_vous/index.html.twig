{% extends 'base.html.twig' %}

{% block title %}Mes Rendez-vous{% endblock %}

{% block body %}
<div class="container mt-5">
   
    {# En-t√™te : Titre + Bouton "Nouveau" (seulement pour les patients) #}
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>üóìÔ∏è Mes Rendez-vous</h1>
       
        {% if is_granted('ROLE_PATIENT') %}
            <a href="{{ path('app_rdv_new') }}" class="btn btn-primary btn-lg shadow">
                + Prendre un RDV
            </a>
        {% endif %}
    </div>

    {# Carte principale #}
    <div class="card shadow-sm">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover table-striped mb-0 align-middle">
                    <thead class="table-dark">
                        <tr>
                            <th>Date & Heure</th>
                           
                            {# Affichage conditionnel de la colonne "Avec qui ?" #}
                            {% if is_granted('ROLE_MEDECIN') %}
                                <th>Patient</th>
                            {% else %}
                                <th>M√©decin</th>
                            {% endif %}
                           
                            <th>Type</th>
                            <th>Lieu / Lien</th>
                            <th>Statut</th>
                            <th class="text-end">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                    {% for rdv in rendez_vous %}
                        <tr>
                            {# 1. Date #}
                            <td class="fw-bold text-primary">
                                {{ rdv.dateHeure|date('d/m/Y') }} <br>
                                <small class="text-muted">{{ rdv.dateHeure|date('H:i') }}</small>
                            </td>

                            {# 2. Interlocuteur #}
                            <td>
                                {% if is_granted('ROLE_MEDECIN') %}
                                    üë§ {{ rdv.patient.nom }} {{ rdv.patient.prenom }}
                                {% else %}
                                    üë®‚Äç‚öïÔ∏è Dr. {{ rdv.medecin.nom }} {{ rdv.medecin.prenom }}
                                {% endif %}
                            </td>

                            {# 3. Type (Pr√©sentiel ou T√©l√©) #}
                            <td>
                                {% if rdv.type == 'T√©l√©m√©decine' %}
                                    <span class="badge bg-info text-dark">üíª Visio</span>
                                {% else %}
                                    <span class="badge bg-secondary">üè• Cabinet</span>
                                {% endif %}
                            </td>

                            {# 4. Lieu ou Lien Visio #}
                            <td>
                                {% if rdv.type == 'T√©l√©m√©decine' %}
                                    {% if rdv.lienVisio %}
                                        <a href="{{ rdv.lienVisio }}" target="_blank" class="btn btn-sm btn-outline-primary">
                                            Rejoindre la r√©union
                                        </a>
                                    {% else %}
                                        <span class="text-muted">Lien en attente</span>
                                    {% endif %}
                                {% else %}
                                    {# Si c'est en pr√©sentiel, on affiche le lieu #}
                                    {% if rdv.lieu %}
                                        {{ rdv.lieu.nom }}<br>
                                        <small class="text-muted">{{ rdv.lieu.ville }}</small>
                                    {% else %}
                                        <span class="text-muted">√Ä d√©finir</span>
                                    {% endif %}
                                {% endif %}
                            </td>

                            {# 5. Statut (Code couleur) #}
                            <td>
                                {% if rdv.statut == 'Confirm√©' %}
                                    <span class="badge bg-success">Confirm√©</span>
                                {% elseif rdv.statut == 'Annul√©' %}
                                    <span class="badge bg-danger">Annul√©</span>
                                {% elseif rdv.statut == 'Termin√©' %}
                                    <span class="badge bg-secondary">Termin√©</span>
                                {% else %}
                                    <span class="badge bg-warning text-dark">En attente</span>
                                {% endif %}
                            </td>

                            {# 6. Actions (Boutons) #}
                            <td class="text-end">
                                {# Si c'est un MEDECIN et que le RDV est pass√© ou confirm√© #}
                                {% if is_granted('ROLE_MEDECIN') and rdv.ordonnance is null %}
                                    <a href="#" class="btn btn-sm btn-success">
                                        üìù Cr√©er Ordonnance
                                    </a>
                                {% endif %}

                                {# Si une ordonnance existe d√©j√† #}
                                {% if rdv.ordonnance %}
                                    <a href="#" class="btn btn-sm btn-info text-white">
                                        üìÑ Voir Ordonnance
                                    </a>
                                {% endif %}

                                {# Bouton Annuler (Seulement si le RDV est futur) #}
                                {% if rdv.dateHeure > date() and rdv.statut != 'Annul√©' %}
                                    {# Tu devras cr√©er la route de suppression plus tard #}
                                    <form method="post" action="{{ path('app_rdv_delete', {'id': rdv.id}) }}" onsubmit="return confirm('√ätes-vous s√ªr de vouloir supprimer ce rendez-vous ?');">
    {# Ce token est OBLIGATOIRE pour la s√©curit√© Symfony #}
    <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ rdv.id) }}">
    <button class="btn btn-sm btn-danger">üóëÔ∏è</button>
</form>
                                {% endif %}
                                {% if rdv.dateHeure > date() %} <a href="{{ path('app_rdv_edit', {'id': rdv.id}) }}" class="btn btn-sm btn-warning text-dark"> ‚úèÔ∏è </a> {% endif %}
                            </td>
                        </tr>
                    {% else %}
                        {# Si la liste est vide #}
                        <tr>
                            <td colspan="6" class="text-center py-5">
                                <h4 class="text-muted">Aucun rendez-vous trouv√© üòï</h4>
                                {% if is_granted('ROLE_PATIENT') %}
                                    <a href="{{ path('app_rdv_new') }}" class="btn btn-primary mt-3">Prendre mon premier RDV</a>
                                {% endif %}
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}
