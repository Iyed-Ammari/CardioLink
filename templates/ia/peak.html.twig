{% extends 'base.html.twig' %}

{% block body %}

{% if is_granted('ROLE_ADMIN') %}
<a href="{{ path('admin_dashboard') }}" style="display:inline-block; margin-bottom:20px;">‚Üê Retour Dashboard</a>
{% endif %}

{% if peaks|length > 0 %}
<div class="alert alert-danger">
    üö® Pic critique pr√©vu prochainement !
</div>
{% endif %}

<h2>Pr√©diction des 30 prochains jours</h2>

<form method="get">
    <select name="sort">
        <option value="">-- Trier --</option>
        <option value="prediction_desc">Plus grand pic</option>
        <option value="date_asc">Date croissante</option>
    </select>

    <input type="number" name="min" placeholder="Minimum sign ups">

    <select name="risk">
        <option value="">-- Niveau de Charge --</option>
        <option value="CRITIQUE">Critique</option>
        <option value="MOYEN">Moyen</option>
        <option value="NORMAL">Normal</option>
    </select>

    <button type="submit">Rechercher</button>
</form>

<table border="1">
    <tr>
        <th>Date</th>
        <th>Pr√©diction</th>
        <th>Niveau de Charge</th>
    </tr>
    {% for r in results %}
    <tr>
        <td>{{ r.date }}</td>
        <td>{{ r.prediction|round(0) }}</td>
        <td>
            {% if r.risk == 'CRITIQUE' %}
                <span style="color:red;">üî¥ CRITIQUE</span>
            {% elseif r.risk == 'MOYEN' %}
                <span style="color:orange;">üü† MOYEN</span>
            {% else %}
                <span style="color:green;">üü¢ NORMAL</span>
            {% endif %}
        </td>
    </tr>
    {% endfor %}
</table>

<canvas id="chart" style="max-height:400px;"></canvas>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    var rawData = {{ results|json_encode|raw }};

    if (rawData.length > 0) {
        var labels = rawData.map(function(d) { return d.date; });
        var values = rawData.map(function(d) { return d.prediction; });
        var colors = rawData.map(function(d) {
            if (d.risk === 'CRITIQUE') return 'red';
            if (d.risk === 'MOYEN') return 'orange';
            return 'green';
        });

        var ctx = document.getElementById('chart').getContext('2d');
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Pr√©diction Sign Ups',
                    data: values,
                    borderWidth: 2,
                    borderColor: 'blue',
                    backgroundColor: 'rgba(0,0,255,0.1)',
                    pointBackgroundColor: colors,
                    pointRadius: 5,
                    fill: true,
                    tension: 0.3
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: { beginAtZero: false }
                }
            }
        });
    } else {
        document.getElementById('chart').style.display = 'none';
    }
</script>

{% endblock %}