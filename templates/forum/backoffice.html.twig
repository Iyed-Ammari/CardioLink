<link rel="stylesheet" href="{{ asset('assets/forum.css') }}">

<!-- Top Header -->
<header class="top-header">
  <div class="header-left">
<img src="{{ asset('assets/image/logo.png') }}" alt="Logo" class="logo" style="width:80px; height:100px;">    <div class="platform-name">
      <span class="title">CardioLink</span>
      <span class="subtitle">Healthcare Platform</span>
    </div>
  </div>

  <div class="header-center">
    <span class="community-name" style="background: linear-gradient(45deg, #2F60F5, #F82239); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">Wellness <strong>Community</strong></span>
    <span class="community-subtitle">Connect, Share, and Manage Posts & Comments</span>
  </div>

  <div class="header-right">
    <input type="text" placeholder="Search posts..." class="search-bar">
  </div>
</header>

<div class="container">

  <!-- Sidebar gauche -->
  <nav class="sidebar">
    <div class="logo">backoffice</div>
    <a href="{{ path('forum_frontoffice') }}" style="background: ; text-align:center; margin-bottom:0.5rem; display:block; padding:0.5rem; border-radius:5px; font-weight:600; cursor:pointer;">
      Aller au Front-Office
    </a>

    <a href="{{ path('forum_frontoffice') }}" class="active">Community</a>
    <a href="#">Dashboard</a>
    <a href="#">Patients</a>
    <a href="#">Monitoring</a>
    <a href="#">Appointments</a>
    <a href="#">Reports</a>
    <a href="#">Notifications</a>
    <a href="#">Settings</a>
  </nav>


  <!-- Contenu principal + panel droit -->
  <div class="content-area">

    <div class="main-content">
      <h2>Liste des posts</h2>

      {% for post in posts %}
        <article class="post-card admin" style="margin-bottom:1rem; padding:1rem; border-radius:8px; border-left: 4px solid #2F60F5; background:#fff;">
          <h3>{{ post.title }}</h3>
          <p>{{ post.content }}</p>
          <p class="post-meta">Par {{ post.user.nom }} {{ post.user.prenom }} ({{ post.user.roles|join(', ') }})</p>
          <small>{{ post.createdAt|date('d/m/Y H:i') }}</small>

          <!-- Bouton supprimer post -->
          <form method="post" action="{{ path('forum_delete', { id: post.id }) }}" style="margin-top:0.5rem;">
            <button style="background: linear-gradient(45deg, #2F60F5, #F82239); color:#fff; border:none; padding:0.5rem 1rem; border-radius:5px; font-weight:600; cursor:pointer;">Supprimer le post</button>
          </form>

          <!-- Bouton toggle commentaires -->
          <button class="toggle-comments-btn" style="
              margin-top:0.5rem; 
              background: linear-gradient(45deg, #2F60F5, #F82239); 
              color:#fff; 
              border:none; 
              padding:0.5rem 1rem; 
              border-radius:5px; 
              cursor:pointer;
              font-weight:600;
          ">
              Afficher les commentaires
          </button>

          <!-- Section commentaires -->
          <div class="comments-section" style="display:none; margin-top:1rem; padding-top:1rem; border-top:1px solid #ddd;">
            <h4>Commentaires</h4>

            {% for comment in post.comments %}
              <div class="comment-card" style="margin-bottom:0.8rem; padding:0.5rem; border:1px solid #eee; border-radius:8px;">
                <p>{{ comment.content }}</p>
                <p class="post-meta">
                  Par {{ comment.user.nom }} {{ comment.user.prenom }}
                  • {{ comment.createdAt|date('d/m/Y H:i') }}
                </p>

                <!-- Bouton supprimer commentaire -->
                <form method="post" action="{{ path('comment_delete', { id: comment.id }) }}">
                  <button style="background: linear-gradient(45deg, #F82239, #2F60F5); color:#fff; border:none; padding:0.3rem 0.8rem; border-radius:5px; cursor:pointer;">Supprimer</button>
                </form>
              </div>
            {% else %}
              <p style="color:#6b7280;">Aucun commentaire pour le moment.</p>
            {% endfor %}
          </div>
        </article>
      {% else %}
        <p>Aucun post pour le moment.</p>
      {% endfor %}
    </div>

    <!-- Right panel -->
    <div class="right-panel">
      <div class="panel-card">
        <h3>Statistiques</h3>
        <ul>
          <li>Total posts : {{ posts|length }}</li>
          <li>Total commentaires : {{ comments|length }}</li>
        </ul>
      </div>
    </div>

  </div>
</div>

<!-- JS simple pour toggle commentaires -->
<script>
  document.querySelectorAll('.toggle-comments-btn').forEach(button => {
    button.addEventListener('click', () => {
      const comments = button.nextElementSibling;
      if (comments.style.display === 'none') {
        comments.style.display = 'block';
        button.textContent = 'Masquer les commentaires';
      } else {
        comments.style.display = 'none';
        button.textContent = 'Afficher les commentaires';
      }
    });
  });
</script>

<!-- JS pour recherche et tri -->
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const searchInput = document.getElementById('search-admin');
    const sortSelect = document.getElementById('sort-admin');
    const postsContainer = document.getElementById('posts-container-admin');

    // Fonction pour trier et afficher les posts
    function sortAndDisplayPosts() {
      const query = searchInput.value.toLowerCase().trim();
      const sortValue = sortSelect.value;
      
      // Récupérer tous les posts en tant qu'array
      let allPosts = Array.from(postsContainer.querySelectorAll('.post-card'));
      
      // Filtrer par recherche
      let visiblePosts = allPosts.filter(post => {
        const title = post.querySelector('h3').textContent.toLowerCase();
        return title.includes(query);
      });

      // Trier les posts
      visiblePosts.sort((a, b) => {
        if (sortValue === 'titre-asc') {
          const titleA = a.querySelector('h3').textContent.toLowerCase();
          const titleB = b.querySelector('h3').textContent.toLowerCase();
          return titleA.localeCompare(titleB);
        } else if (sortValue === 'titre-desc') {
          const titleA = a.querySelector('h3').textContent.toLowerCase();
          const titleB = b.querySelector('h3').textContent.toLowerCase();
          return titleB.localeCompare(titleA);
        } else if (sortValue === 'recent') {
          const dateStrA = a.querySelector('small').textContent;
          const dateStrB = b.querySelector('small').textContent;
          const dateA = parseDate(dateStrA);
          const dateB = parseDate(dateStrB);
          return dateB - dateA;
        } else if (sortValue === 'ancien') {
          const dateStrA = a.querySelector('small').textContent;
          const dateStrB = b.querySelector('small').textContent;
          const dateA = parseDate(dateStrA);
          const dateB = parseDate(dateStrB);
          return dateA - dateB;
        }
      });

      // Réorganiser les posts dans le DOM
      allPosts.forEach(post => post.style.display = 'none');
      visiblePosts.forEach(post => {
        post.style.display = 'block';
        postsContainer.appendChild(post);
      });
    }

    // Fonction pour parser la date au format "d/m/Y H:i"
    function parseDate(dateStr) {
      const parts = dateStr.trim().split(' ');      
      if (parts.length >= 2) {
        const [day, month, year] = parts[0].split('/');
        const [hours, minutes] = parts[1].split(':');
        return new Date(year, month - 1, day, hours, minutes);
      }
      return new Date(0);
    }

    // Événements pour recherche et tri
    searchInput.addEventListener('input', sortAndDisplayPosts);
    sortSelect.addEventListener('change', sortAndDisplayPosts);
  });
</script>