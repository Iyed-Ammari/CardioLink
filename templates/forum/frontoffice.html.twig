<link rel="stylesheet" href="{{ asset('assets/forum.css') }}">

<!-- ================= TOP HEADER ================= -->
<header class="top-header" style="display:flex; justify-content:space-between; align-items:center; padding:1rem 2rem; background:#fff; box-shadow:0 2px 8px rgba(0,0,0,0.05); border-bottom-left-radius:1rem; border-bottom-right-radius:1rem;">

  <!-- ===== LEFT ===== -->
  <div class="header-left" style="display:flex; align-items:center; gap:0.8rem;">
    <img src="{{ asset('assets/image/logo.png') }}" alt="Logo" class="logo" style="width:80px; height:100px;">
    <div class="platform-name" style="display:flex; flex-direction:column;">
      <span class="title" style="font-weight:700; font-size:1.2rem;">CardioLink</span>
      <span class="subtitle" style="font-size:0.9rem; color:#555;">Healthcare Platform</span>
    </div>
    {% if app.user and 'ROLE_ADMIN' in app.user.roles %}
    <a href="{{ path('forum_backoffice') }}" style="margin-left:2rem; color:#2F60F5; font-weight:600; text-decoration:none;">Aller au Back-Office</a>
    {% endif %}
  </div>

  <!-- ===== CENTER ===== -->
  <div class="header-center" style="display:flex; flex-direction:column; align-items:center; flex:1; margin:0 1rem;">
    <span class="community-name" style="font-weight:600; font-size:1.1rem;">Wellness <strong>Community</strong></span>
    <span class="community-subtitle" style="font-size:0.85rem; color:#666;">Connect, Share, and Grow Together ‚Ä¢ Active Members: {{ posts|length }}</span>

    <!-- Barre de recherche et tri -->
    <div style="display:flex; gap:0.5rem; margin-top:0.5rem; align-items:center;">
      <form method="get" action="{{ path('forum_frontoffice') }}" style="display:flex; gap:0.5rem; align-items:center;">
        <input 
          type="text" 
          name="search"
          placeholder="Rechercher par titre..."
          value="{{ search }}"
          class="search-input"
          style="padding:0.5rem 0.8rem; width:250px; border-radius:6px; border:1px solid #ccc; outline:none;"
        />
        
        <!-- Boutons de tri -->
        <select name="sort" style="padding:0.5rem 0.8rem; border-radius:6px; border:1px solid #ccc; background:#fff; cursor:pointer; outline:none;" onchange="this.form.submit();">
          <option value="recent" {% if sort == 'recent' %}selected{% endif %}>R√©cent</option>
          <option value="ancien" {% if sort == 'ancien' %}selected{% endif %}>Ancien</option>
          <option value="titre-asc" {% if sort == 'titre-asc' %}selected{% endif %}>Titre (A-Z)</option>
          <option value="titre-desc" {% if sort == 'titre-desc' %}selected{% endif %}>Titre (Z-A)</option>
        </select>

        <button type="submit" style="padding:0.5rem 0.8rem; background:#2F60F5; color:#fff; border:none; border-radius:6px; cursor:pointer; font-weight:600;">Rechercher</button>
      </form>
    </div>
  </div>

  <div class="header-right" style="display:flex; align-items:center; gap:1rem;">
    <div class="notification" id="notification" style="position:relative; cursor:pointer;">
        <span class="bell" style="font-size:1.4rem;">üîî</span>
        <span class="badge" style="position:absolute; top:-6px; right:-6px; background:red; color:#fff; font-size:0.75rem; padding:2px 6px; border-radius:50%; font-weight:700;">{{ posts|length }}</span>
    </div>
  </div>

</header>
    <!-- Popup pour posts r√©cents -->
    <div id="notif-popup" style="display:none; position:absolute; right:0; top:56px; width:340px; background:linear-gradient(135deg, #F82239 0%, #2F60F5 100%); box-shadow:0 8px 32px rgba(47,96,245,0.13), 0 1.5px 8px rgba(0,0,0,0.08); border-radius:18px; z-index:1000; padding:1.1rem 1.2rem 1.2rem 1.2rem; border:1px solid #2F60F5; transition:box-shadow 0.3s,background 0.3s; color:#fff;">
        {% include 'forum/_recent_posts.html.twig' with {'posts': posts} %}
    </div>
</div>
</header>

<div class="container" style="display:flex; gap:1.2rem;">

  <!-- ================= SIDEBAR GAUCHE ================= -->
  <nav class="sidebar" style="min-width:170px; margin-right:0.5rem;">
    <div class="logo">CardioLink</div>
    {% if app.user and 'ROLE_ADMIN' in app.user.roles %}
    <a href="{{ path('forum_backoffice') }}" style="color:#000000;">Aller au Back-Office</a>
    {% endif %}
    <a href="{{ path('forum_frontoffice') }}" class="active">Community</a>
    <a href="{{ path('app_home') }}">Home</a>
    {% if is_granted('ROLE_PATIENT') %}
    <a href="{{ path('app_suivi_index') }}">üìä Mes Suivis</a>
    <a href="#">Mon Dossier M√©dical</a>
    {% endif %}
    {% if is_granted('ROLE_MEDECIN') %}
    <a href="{{ path('app_intervention_index') }}">üè• Interventions</a>
    <a href="{{ path('app_intervention_urgent') }}">üö® SOS</a>
    <a href="#">G√©rer mes Patients</a>
    {% endif %}
    {% if is_granted('ROLE_ADMIN') %}
    <a href="#">Administration</a>
    {% endif %}
    <a href="{{ logout_path() }}">Logout</a>
  </nav>

  <!-- ================= CONTENT ================= -->
  <div class="content-area" style="flex:1;">
    <div class="main-content">

      <!-- ========== CREATE POST FACEBOOK STYLE ========== -->
<div class="create-post card-shadow" style="margin-bottom:2rem; border-radius:18px; background:linear-gradient(135deg,#f8fafc 80%,#f1f5f9 100%); padding:1.3rem 1.7rem; border:1px solid #e5e7eb; box-shadow:0 4px 24px rgba(47,96,245,0.08); max-width:540px; margin-left:auto; margin-right:auto;">

    <form method="post" action="{{ path('forum_frontoffice') }}" class="fb-post-form" enctype="multipart/form-data" style="display:flex; flex-direction:column; gap:1.1rem;">

        <!-- Auteur du post -->
        <div style="display:flex; align-items:center; gap:0.8rem; margin-bottom:1rem;">
            <div style="width:48px;height:48px;border-radius:50%; background:linear-gradient(135deg, #2F60F5, #F82239); display:flex; align-items:center; justify-content:center; font-weight:bold; color:#fff; font-size:1.2rem;">
                {{ app.user.nom|first }}
            </div>
            <div>
                <div style="font-weight:600; color:#1f2937;">{{ app.user.nom }} {{ app.user.prenom }}</div>
                <div style="font-size:0.85rem; color:#6b7280;">√Ä votre communaut√©</div>
            </div>
        </div>

       <!-- Formulaire complet pour publication avec audio -->
<form id="postForm">
    <!-- Bouton micro / audio -->
    <button type="button" id="startRecording">üé§ Parler</button>

    <!-- R√©sultat de la transcription -->
    <div id="result" style="margin:0.5rem 0; color:#111;"></div>

    <!-- Textarea principale pour le contenu -->
    <textarea id="postContent" name="content" rows="3"
        placeholder="Quoi de neuf ? üí≠"
        class="fb-textarea"
        style="width:100%; padding:1.1rem; border:2px solid #e5e7eb; border-radius:12px; font-size:1.05rem; resize:none; transition:all 0.3s; font-family:inherit; background:#f8fafc;">
    </textarea>
    <span class="error-msg" style="color:red; font-size:0.85rem; display:block; margin-top:0.5rem;"></span>

    <!-- Zone cach√©e pour titre et image -->
    <div class="fb-hidden-zone" style="margin-top:1.1rem; flex-direction:column; gap:0.9rem; display:flex;">
        <!-- Titre optionnel -->
        <input type="text" name="title" placeholder="‚úèÔ∏è Ajouter un titre (optionnel)"
            style="padding:0.95rem 1.1rem; border:2px solid #e5e7eb; border-radius:12px; font-size:1.01rem; transition:all 0.3s; background:#f8fafc;">
        <span class="error-msg" style="color:red; font-size:0.85rem;"></span>

        <!-- Image optionnelle -->
        <input type="file" name="image" accept="image/*"
            style="padding:0.7rem 1.1rem; border:2px solid #e5e7eb; border-radius:12px; font-size:1.01rem; transition:all 0.3s; cursor:pointer; background:#f8fafc;">
        <span class="error-msg" style="color:red; font-size:0.85rem;"></span>

        <!-- Boutons Annuler et Publier -->
        <div style="display:flex; justify-content:flex-end; gap:0.7rem; margin-top:0.2rem;">
            <button type="button" class="btn-cancel"
                onclick="document.querySelector('.fb-hidden-zone').style.display='none'; document.querySelector('.fb-textarea').rows=3;"
                style="background:#e5e7eb; color:#374151; padding:0.8rem 1.7rem; border-radius:9px; font-weight:600; cursor:pointer; border:none; transition:all 0.3s;">
                Annuler
            </button>

            <button type="submit"
                style="background:linear-gradient(135deg, #2F60F5, #1d4ed8); color:#fff; border:none; padding:0.8rem 2.1rem; border-radius:9px; font-weight:600; cursor:pointer; transition:all 0.3s; box-shadow:0 2px 8px rgba(47,96,245,0.10);">
                üì§ Publier
            </button>
        </div>
    </div>
</form>

      <!-- ================= POSTS ================= -->
      <div id="posts-container">
        {% for post in posts %}
        <article class="post-card card-shadow" 
         style="margin-bottom:1.5rem; padding:0; border-radius:18px; background:linear-gradient(135deg,#f8fafc 80%,#f1f5f9 100%); border:1px solid #e5e7eb; overflow:hidden; box-shadow:0 4px 24px rgba(47,96,245,0.08); max-width:760px; margin-left:auto; margin-right:auto; transition:box-shadow 0.3s,transform 0.3s;">

          <!-- POST HEADER (Avatar + Nom + Date) -->
          <div style="padding:0.9rem 1.3rem 0.7rem 1.3rem; border-bottom:1px solid #e5e7eb; display:flex; justify-content:space-between; align-items:flex-start; background:transparent;">
            <div style="display:flex; align-items:center; gap:0.8rem; flex:1;">
              <div style="width:44px;height:44px;border-radius:50%; background:linear-gradient(135deg, #2F60F5, #F82239); display:flex; align-items:center; justify-content:center; font-weight:bold; color:#fff; font-size:1rem;">
                {{ post.user.nom|first }}{{ post.user.prenom|first }}
              </div>
              <div>
                <div style="font-weight:600; color:#1f2937; display:flex; align-items:center; gap:0.4rem;">
                  {{ post.user.nom }} {{ post.user.prenom }}
                 {% if flamesByUser[post.user.id] is defined and flamesByUser[post.user.id] > 0 %}
        <span title="Flammes" style="font-size:1.2rem; display:flex; align-items:center; gap:0.2rem;">
            üî•
            <span style="font-size:1rem; font-weight:700; margin-left:0.2rem;">
                {{ flamesByUser[post.user.id] }}
            </span>
        </span>
    {% endif %}
</div>
<!-- Bouton R√©sum√© IA -->
{% if post.content|length > 200 %}
<form method="post" action="{{ path('generate_summary', {'id': post.id}) }}" style="margin-top:0.8rem;">
    <button type="submit" style="background:linear-gradient(135deg, #2F60F5, #1d4ed8); 
                                color:#fff; border:none; padding:0.5rem 1rem; 
                                border-radius:8px; font-weight:600; cursor:pointer;">
        ü§ñ G√©n√©rer r√©sum√© IA
    </button>
</form>
{% endif %}

    {% if post.summary is defined and post.summary %}
        <div style="margin-top:0.5rem; padding:0.8rem 1rem; background:#f1f5f9; border-radius:10px; font-size:0.95rem;">
            <strong>R√©sum√© IA :</strong> {{ post.summary }}
        </div>
    {% endif %}

                <div style="font-size:0.85rem; color:#6b7280;" data-time="{{ post.createdAt|date('U') }}">
                  <span class="time-ago">il y a quelques secondes</span>
                </div>
              </div>
            </div>
            
            <!-- MENU 3 POINTS -->
            {% if app.user and post.user.id == app.user.id %}
            <div style="position:relative;">
              <button class="btn-menu-post" style="background:none; border:none; font-size:1.5rem; cursor:pointer; color:#6b7280; padding:0; transition:all 0.2s ease;">‚ãØ</button>
              <div class="post-menu" style="display:none; position:absolute; top:100%; right:0; background:#fff; box-shadow:0 4px 12px rgba(0,0,0,0.15); border-radius:8px; z-index:100; min-width:150px; border:1px solid #e5e7eb;">
                <button type="button" class="btn-edit-menu" style="width:100%; text-align:left; padding:0.8rem 1rem; background:none; border:none; cursor:pointer; font-size:0.95rem; color:#374151; transition:all 0.2s ease; border-bottom:1px solid #e5e7eb;">
                  ‚úèÔ∏è Modifier
                </button>
                <form method="post" action="{{ path('forum_delete', {'id': post.id}) }}" style="display:block;">
                  <button type="submit" style="width:100%; text-align:left; padding:0.8rem 1rem; background:none; border:none; cursor:pointer; font-size:0.95rem; color:#ef4444; transition:all 0.2s ease; font-weight:500;">
                    üóëÔ∏è Supprimer
                  </button>
                </form>
              </div>
            </div>
            {% endif %}
          </div>

          <!-- POST CONTENT -->
          <!-- POST CONTENT -->
<div class="post-display" style="padding:1.1rem 1.3rem 0.7rem 1.3rem; background:transparent;">
  {% if post.title %}
    <h3 class="post-title" style="margin-bottom:0.8rem; color:#1f2937; font-size:1.2rem; font-weight:700;">
      {{ post.title }}
    </h3>
  {% endif %}
  <p style="color:#4b5563; line-height:1.6; margin:0; word-wrap:break-word;">
    {{ post.content }}
  </p>
 <!-- Affichage du r√©sum√© IA si disponible -->
{% if summariesByPost[post.id] is defined %}
<div class="post-summary" style="margin-top:0.8rem; padding:0.8rem; background:#f1f5f9; border-radius:10px; font-size:0.95rem; color:#374151;">
    ü§ñ <strong>R√©sum√© IA :</strong> {{ summariesByPost[post.id] }}
</div>
{% endif %}
  
  {# IMAGE DU POST #}
  {% if post.image %}
    <div class="post-image" style="display:flex; justify-content:center; margin-top:1.1rem;">
      <img src="{{ asset('uploads/posts/' ~ post.image) }}"
           alt="Image du post"
           style="max-width:320px; width:100%; max-height:220px; object-fit:cover; border-radius:14px; box-shadow:0 2px 12px rgba(47,96,245,0.10); border:1px solid #e5e7eb; padding:4px; background:#f8fafc; transition:box-shadow 0.3s;">
    </div>
  {% endif %}
</div>

          <!-- EDIT POST (Hidden) -->
          <form method="post"
                action="{{ path('forum_edit', {'id': post.id}) }}"
                class="edit-form"
                style="display:none; margin-top:0.8rem; flex-direction:column; gap:0.8rem; padding:1.5rem;">

            <input name="title" value="{{ post.title }}" placeholder="Titre du post" style="padding:0.8rem 1rem; border:2px solid #e5e7eb; border-radius:8px; font-size:0.95rem; transition:all 0.3s ease;">
            <span class="error-msg" style="color:red; font-size:0.85rem;"></span>

            <textarea name="content" rows="3" style="padding:0.8rem 1rem; border:2px solid #e5e7eb; border-radius:8px; font-size:0.95rem; transition:all 0.3s ease;">{{ post.content }}</textarea>
            <span class="error-msg" style="color:red; font-size:0.85rem;"></span>

            <div style="display:flex; gap:0.8rem; justify-content:flex-end;">
              <button type="submit" style="background:linear-gradient(135deg, #2563eb, #1d4ed8); color:#fff; padding:0.7rem 1.5rem; border-radius:8px; font-weight:600; cursor:pointer; transition:all 0.3s ease; border:none;">Enregistrer</button>
              <button type="button" class="btn-cancel" style="background:#e5e7eb; color:#374151; padding:0.7rem 1.5rem; border-radius:8px; font-weight:600; cursor:pointer; transition:all 0.3s ease; border:none;">Annuler</button>
            </div>
          </form>

 <!-- LIKES SECTION (COEUR INSTAGRAM) -->
<div style="padding:0.5rem 1.3rem 0.7rem 1.3rem; display:flex; align-items:center; gap:0.5rem; background:transparent;">
  <div class="like-btn" 
     data-post-id="{{ post.id }}" 
     data-liked="{{ post.isLikedByUser(app.user) ? '1' : '0' }}" 
     style="cursor:pointer; display:flex; align-items:center; gap:0.3rem;">
    <svg class="like-icon" xmlns="http://www.w3.org/2000/svg" 
         viewBox="0 0 24 24" width="24" height="24" style="transition: all 0.3s;">
      
      {% if post.isLikedByUser(app.user) %}
        <path class="heart-path" fill="#ef4444" stroke="#ef4444" stroke-width="2"
          d="M4.318 6.318a4.5 4.5 0 016.364 0L12 7.636l1.318-1.318a4.5 4.5 0 116.364 6.364L12 21.682l-7.682-7.682a4.5 4.5 0 010-6.364z" />
      {% else %}
        <path class="heart-path" fill="none" stroke="#6b7280" stroke-width="2"
          d="M4.318 6.318a4.5 4.5 0 016.364 0L12 7.636l1.318-1.318a4.5 4.5 0 116.364 6.364L12 21.682l-7.682-7.682a4.5 4.5 0 010-6.364z" />
      {% endif %}
      
    </svg>

    <span class="like-count" style="font-size:0.85rem; color:#6b7280;">
      {{ post.likes }}
    </span>
    
  </div>
</div>
          <!-- COMMENTAIRES SECTION -->
          <div style="border-top:1px solid #e5e7eb; padding:0.9rem 1.3rem; background:linear-gradient(135deg,#f1f5f9 80%,#f8fafc 100%); border-bottom-left-radius:18px; border-bottom-right-radius:18px;">
            <div style="display:flex; gap:0.8rem; margin-bottom:1.2rem; padding-bottom:1rem; border-bottom:1px solid #e5e7eb;">
              <span style="color:#6b7280; font-size:0.9rem;">üí¨ {{ post.comments|length }} commentaire(s)</span>
            </div>

            <!-- COMMENTAIRES LIST -->
            {% for comment in post.comments %}
            <div class="comment-item" style="margin-bottom:1rem; padding:1rem; background:#f9fafb; border-radius:8px; border:1px solid #e5e7eb;">

              <!-- COMMENT HEADER -->
              <div style="display:flex; gap:0.8rem; margin-bottom:0.8rem; justify-content:space-between; align-items:flex-start;">
                <div style="display:flex; gap:0.8rem; flex:1;">
                  <div style="width:32px;height:32px;border-radius:50%; background:linear-gradient(135deg, #9333ea, #6366f1); display:flex; align-items:center; justify-content:center; font-weight:bold; color:#fff; font-size:0.9rem;">
                    {{ comment.user.nom|first }}
                  </div>
                  <div style="flex:1;">
                    <div style="font-weight:600; color:#1f2937; font-size:0.9rem;">{{ comment.user.nom }} {{ comment.user.prenom }}</div>
                    <div style="font-size:0.8rem; color:#9ca3af;" data-time="{{ comment.createdAt|date('U') }}">
                      <span class="comment-time-ago">il y a quelques secondes</span>
                    </div>
                  </div>
                </div>
                
                <!-- MENU 3 POINTS COMMENT -->
                {% if app.user and comment.user.id == app.user.id %}
                <div style="position:relative;">
                  <button class="btn-menu-comment" style="background:none; border:none; font-size:1.2rem; cursor:pointer; color:#6b7280; padding:0; transition:all 0.2s ease;">‚ãØ</button>
                  <div class="comment-menu" style="display:none; position:absolute; top:100%; right:0; background:#fff; box-shadow:0 4px 12px rgba(0,0,0,0.15); border-radius:8px; z-index:100; min-width:120px; border:1px solid #e5e7eb;">
                    <button type="button" class="btn-edit-comment-menu" style="width:100%; text-align:left; padding:0.6rem 0.8rem; background:none; border:none; cursor:pointer; font-size:0.9rem; color:#374151; transition:all 0.2s ease; border-bottom:1px solid #e5e7eb;">
                      ‚úèÔ∏è Modifier
                    </button>
                    <form method="post" action="{{ path('comment_delete', {'id': comment.id}) }}" style="display:block;">
                      <button type="submit" style="width:100%; text-align:left; padding:0.6rem 0.8rem; background:none; border:none; cursor:pointer; font-size:0.9rem; color:#ef4444; transition:all 0.2s ease; font-weight:500;">
                        üóëÔ∏è Supprimer
                      </button>
                    </form>
                  </div>
                </div>
                {% endif %}
              </div>

              <!-- COMMENT DISPLAY -->
              <div class="comment-display" style="color:#4b5563; margin-bottom:0.8rem;">
                {{ comment.content }}
              </div>

              <!-- COMMENT EDIT FORM (Hidden) -->
              <form method="post"
                    action="{{ path('comment_edit', {'id': comment.id}) }}"
                    class="comment-edit-form"
                    style="display:none; margin-top:0.8rem; flex-direction:column; gap:0.8rem;">

                <input type="text" name="content" value="{{ comment.content }}" style="padding:0.8rem 1rem; border:2px solid #e5e7eb; border-radius:8px; font-size:0.95rem; transition:all 0.3s ease; flex:1;">
                <span class="error-msg" style="color:red; font-size:0.85rem;"></span>

                <div style="display:flex; gap:0.6rem;">
                  <button type="submit" style="background:linear-gradient(135deg, #2563eb, #1d4ed8); color:#fff; padding:0.6rem 1.2rem; border-radius:8px; font-weight:600; cursor:pointer; transition:all 0.3s ease; border:none;">OK</button>
                  <button type="button" class="btn-cancel-comment" style="background:#e5e7eb; color:#374151; padding:0.6rem 1.2rem; border-radius:8px; font-weight:600; cursor:pointer; transition:all 0.3s ease; border:none;">Annuler</button>
                </div>
              </form>



            </div>
            {% endfor %}

            <!-- FORM AJOUTER COMMENT -->
            <form method="post"
                  action="{{ path('comment_add', {'postId': post.id}) }}"
                  style="margin-top:1.2rem; display:flex; gap:0.8rem; align-items:center;">

              <div style="width:32px;height:32px;border-radius:50%; background:linear-gradient(135deg, #2F60F5, #F82239); display:flex; align-items:center; justify-content:center; font-weight:bold; color:#fff; font-size:0.9rem;">
                {{ app.user.nom|first }}
              </div>
              <input name="content" placeholder="‚úçÔ∏è Commentez..." style="flex:1; padding:0.8rem 1rem; border:2px solid #e5e7eb; border-radius:8px; font-size:0.95rem; transition:all 0.3s ease;">
              <span class="error-msg" style="color:red; font-size:0.85rem; position:absolute;"></span>

              <button type="submit" style="background:linear-gradient(135deg, #2563eb, #1d4ed8); color:#fff; padding:0.8rem 1.5rem; border-radius:8px; font-weight:600; cursor:pointer; white-space:nowrap; transition:all 0.3s ease; border:none;">üí¨ Envoyer</button>
            </form>

          </div>

        </article>
        {% endfor %}
      </div>

    </div>
  </div>
</div>

<!-- ================= JS ================= -->
<script>
document.addEventListener('DOMContentLoaded', () => {

  // ===== MENU 3 POINTS POSTS =====
  document.querySelectorAll('.btn-menu-post').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      const menu = btn.nextElementSibling;
      
      // Fermer tous les autres menus
      document.querySelectorAll('.post-menu').forEach(m => {
        if (m !== menu) m.style.display = 'none';
      });
      
      menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
    });
  });

  // ===== MENU 3 POINTS COMMENTS =====
  document.querySelectorAll('.btn-menu-comment').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      const menu = btn.nextElementSibling;
      
      // Fermer tous les autres menus
      document.querySelectorAll('.comment-menu').forEach(m => {
        if (m !== menu) m.style.display = 'none';
      });
      
      menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
    });
  });

  // G√©rer le clic sur "Modifier" dans le menu comment
  document.querySelectorAll('.btn-edit-comment-menu').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      const item = btn.closest('.comment-item');
      item.querySelector('.comment-display').style.display = 'none';
      item.querySelector('.comment-edit-form').style.display = 'flex';
      item.querySelector('.comment-menu').style.display = 'none';
    });
  });

  // Fermer menus en cliquant ailleurs
  document.addEventListener('click', () => {
    document.querySelectorAll('.post-menu').forEach(menu => {
      menu.style.display = 'none';
    });
    document.querySelectorAll('.comment-menu').forEach(menu => {
      menu.style.display = 'none';
    });
  });

  // G√©rer le clic sur "Modifier" dans le menu
  document.querySelectorAll('.btn-edit-menu').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      const article = btn.closest('.post-card');
      article.querySelector('.post-display').style.display = 'none';
      article.querySelector('.edit-form').style.display = 'flex';
      article.querySelector('.post-menu').style.display = 'none';
    });
  });

  // ===== Fonctions √©dition posts (ANCIEN CODE) =====
  document.querySelectorAll('.btn-edit').forEach(btn => {
    btn.addEventListener('click', () => {
      const article = btn.closest('.post-card');
      article.querySelector('.post-display').style.display = 'none';
      article.querySelector('.edit-form').style.display = 'flex';
    });
  });

  document.querySelectorAll('.btn-cancel').forEach(btn => {
    btn.addEventListener('click', () => {
      const article = btn.closest('.post-card');
      article.querySelector('.edit-form').style.display = 'none';
      article.querySelector('.post-display').style.display = 'block';
    });
  });

  // ===== Afficher zone cach√©e post =====
  const textarea = document.querySelector(".fb-textarea");
  const hiddenZone = document.querySelector(".fb-hidden-zone");
  if (textarea) {
    textarea.addEventListener("focus", () => {
      hiddenZone.style.display = "flex";
      textarea.rows = 3;
    });
  }

  // ===== Annuler √©dition commentaires =====
  document.querySelectorAll('.btn-cancel-comment').forEach(btn => {
    btn.addEventListener('click', () => {
      const item = btn.closest('.comment-item');
      item.querySelector('.comment-edit-form').style.display = 'none';
      item.querySelector('.comment-display').style.display = 'block';
    });
  });

  // ===== VALIDATION INLINE MODERNE =====
  function clearErrors(form) {
    form.querySelectorAll('.error-msg').forEach(span => span.textContent = '');
  }

  function validateField(field) {
    const value = field.value.trim();
    const errorSpan = field.nextElementSibling;
    let error = '';

    if (!value) error = `${field.placeholder || field.name} est requis.`;
    else if (field.name === 'title' && value.length < 3) error = 'Le titre doit contenir au moins 3 caract√®res.';
    else if (field.name === 'content' && field.closest('.fb-post-form') && value.length < 5) error = 'Le contenu du post doit contenir au moins 5 caract√®res.';
    else if (field.name === 'content' && (field.closest('.comment-edit-form') || field.closest('form[action*="comment_add"]')) && value.length < 1) error = 'Le commentaire ne peut pas √™tre vide.';

    errorSpan.textContent = error;
    return !error;
  }

  document.querySelectorAll('form').forEach(form => {
    form.addEventListener('submit', e => {
      clearErrors(form);
      let valid = true;
      form.querySelectorAll('input, textarea').forEach(field => {
        if (!validateField(field)) valid = false;
      });
      if (!valid) e.preventDefault();
    });

    form.querySelectorAll('input, textarea').forEach(field => {
      field.addEventListener('input', () => validateField(field));
    });
  });

  // ===== JS notif =====
  const notif = document.getElementById('notification');
  const popup = document.getElementById('notif-popup');

  if (notif) {
      notif.querySelector('.bell').addEventListener('click', (e) => {
          e.stopPropagation();
          popup.style.display = popup.style.display === 'none' ? 'block' : 'none';
      });
  }

  document.addEventListener('click', () => {
      if (popuap) popup.style.display = 'none';
  });
  if (popup) popup.addEventListener('click', e => e.stopPropagation());

  // ===== CALCUL "IL Y A X TEMPS" =====
  function formatTimeAgo(timestamp) {
    const now = new Date().getTime() / 1000;
    const diff = Math.floor(now - timestamp);

    if (diff < 60) return '√† l\'instant';
    if (diff < 3600) return `il y a ${Math.floor(diff / 60)} min`;
    if (diff < 86400) return `il y a ${Math.floor(diff / 3600)}h`;
    if (diff < 604800) return `il y a ${Math.floor(diff / 86400)}j`;
    
    const date = new Date(timestamp * 1000);
    return date.toLocaleDateString('fr-FR');
  }

  // Mettre √† jour les dates
  document.querySelectorAll('[data-time]').forEach(el => {
    const timestamp = parseInt(el.getAttribute('data-time'));
    const span = el.querySelector('.time-ago') || el.querySelector('.comment-time-ago');
    if (span) {
      span.textContent = formatTimeAgo(timestamp);
    }
  });

  // Mettre √† jour chaque minute
  setInterval(() => {
    document.querySelectorAll('[data-time]').forEach(el => {
      const timestamp = parseInt(el.getAttribute('data-time'));
      const span = el.querySelector('.time-ago') || el.querySelector('.comment-time-ago');
      if (span) {
        span.textContent = formatTimeAgo(timestamp);
      }
    });
  }, 60000);

});
</script>
<script>
document.querySelectorAll('.like-btn').forEach(el => {
  el.addEventListener('click', function() {
    const icon = this.querySelector('.like-icon');
    const heart = this.querySelector('.heart-path');
    const countEl = this.querySelector('.like-count');

    const postId = this.getAttribute('data-post-id');

    // R√©cup√©rer l'√©tat initial du like depuis l'attribut data-liked
    let liked = this.getAttribute('data-liked') === '1';

    // Inverser l'√©tat local
    liked = !liked;
    this.setAttribute('data-liked', liked ? '1' : '0');

    // Mise √† jour visuelle imm√©diate
    if (liked) {
      icon.classList.add('liked');
      heart.setAttribute("fill", "#ef4444");
      heart.setAttribute("stroke", "#ef4444");
      countEl.textContent = parseInt(countEl.textContent) + 1;
    } else {
      icon.classList.remove('liked');
      heart.setAttribute("fill", "none");
      heart.setAttribute("stroke", "#6b7280");
      countEl.textContent = parseInt(countEl.textContent) - 1;
    }

    // Requ√™te serveur
    fetch(`/post/${postId}/like`, {
      method: 'POST',
      headers: {
        'X-Requested-With': 'XMLHttpRequest',
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({})
    })
    .then(res => res.json())
    .then(data => {
      countEl.textContent = data.likes;

      if (data.liked) {
        icon.classList.add('liked');
        heart.setAttribute("fill", "#ef4444");
        heart.setAttribute("stroke", "#ef4444");
        this.setAttribute('data-liked', '1');
      } else {
        icon.classList.remove('liked');
        heart.setAttribute("fill", "none");
        heart.setAttribute("stroke", "#6b7280");
        this.setAttribute('data-liked', '0');
      }
    })
    .catch(err => console.error(err));
  });
});

</script>
<script>
// V√©rifier si le navigateur supporte
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

if (!SpeechRecognition) {
    alert("Votre navigateur ne supporte pas la reconnaissance vocale !");
} else {
    const recognition = new SpeechRecognition();
    recognition.lang = 'fr-FR';
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;

    const btn = document.getElementById('startRecording');
    const resultDiv = document.getElementById('result');
    const textarea = document.getElementById('postContent');

    btn.addEventListener('click', () => {
        recognition.start();
        btn.disabled = true;
        btn.textContent = "üéôÔ∏è √âcoute...";
        resultDiv.textContent = "";
    });

    recognition.addEventListener('result', (event) => {
        const transcript = event.results[0][0].transcript;
        resultDiv.textContent = transcript;
        textarea.value = transcript; // Remplit automatiquement le textarea
    });

    recognition.addEventListener('end', () => {
        btn.disabled = false;
        btn.textContent = "üé§ Parler";
    });

    recognition.addEventListener('error', (e) => {
        alert("Erreur reconnaissance vocale : " + e.error);
        btn.disabled = false;
        btn.textContent = "üé§ Parler";
    });
}
</script>
