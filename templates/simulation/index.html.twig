{% extends 'dashboard/base_dashboard.html.twig' %}

{% block body %}
<div style="max-width:1000px; margin:40px auto;">

    <h2>üìà Simulation Pr√©dictive ‚Äî Charge M√©dicale</h2>
    

    {# Formulaire taux #}
    <div style="background:#fff; border-radius:16px; padding:25px; box-shadow:0 4px 15px rgba(0,0,0,0.08); margin-bottom:25px;">
        <h3 style="margin-bottom:15px;">‚öôÔ∏è Param√®tres de simulation</h3>
        <form method="get" style="display:flex; align-items:center; gap:15px; flex-wrap:wrap;">
            <label style="font-weight:700;">Si les patients √† risque augmentent de :</label>
            <input type="number" name="taux" value="{{ taux }}" min="1" max="100"
                style="width:80px; padding:8px; border-radius:8px; border:2px solid #2F60F5; font-size:16px; font-weight:700; text-align:center;">
            <label style="font-weight:700;">%</label>
            <button type="submit"
                style="background:linear-gradient(90deg,#F82239,#2F60F5); color:#fff; padding:10px 20px; border-radius:10px; border:none; cursor:pointer; font-weight:700;">
                üîÆ Simuler
            </button>
        </form>
    </div>

    {# Stats actuelles #}
    <div style="display:flex; gap:15px; margin-bottom:25px; flex-wrap:wrap;">
        <div style="flex:1; min-width:140px; background:#fee2e2; border-radius:12px; padding:15px; text-align:center;">
            <div style="font-size:32px; font-weight:800; color:#dc2626;">{{ stats['CRITIQUE'] }}</div>
            <div style="font-size:13px; color:#dc2626; font-weight:700;">üî¥ CRITIQUE</div>
        </div>
        <div style="flex:1; min-width:140px; background:#ffedd5; border-radius:12px; padding:15px; text-align:center;">
            <div style="font-size:32px; font-weight:800; color:#ea580c;">{{ stats['√âLEV√â'] }}</div>
            <div style="font-size:13px; color:#ea580c; font-weight:700;">üü† √âLEV√â</div>
        </div>
        <div style="flex:1; min-width:140px; background:#fef9c3; border-radius:12px; padding:15px; text-align:center;">
            <div style="font-size:32px; font-weight:800; color:#ca8a04;">{{ stats['MOD√âR√â'] }}</div>
            <div style="font-size:13px; color:#ca8a04; font-weight:700;">üü° MOD√âR√â</div>
        </div>
        <div style="flex:1; min-width:140px; background:#dcfce7; border-radius:12px; padding:15px; text-align:center;">
            <div style="font-size:32px; font-weight:800; color:#16a34a;">{{ stats['NORMAL'] }}</div>
            <div style="font-size:13px; color:#16a34a; font-weight:700;">üü¢ NORMAL</div>
        </div>
        <div style="flex:1; min-width:140px; background:#f1f5f9; border-radius:12px; padding:15px; text-align:center;">
            <div style="font-size:32px; font-weight:800; color:#2F60F5;">{{ total }}</div>
            <div style="font-size:13px; color:#2F60F5; font-weight:700;">üë• TOTAL</div>
        </div>
    </div>


    {# Graphique #}
    <div style="background:#fff; border-radius:16px; padding:25px; box-shadow:0 4px 15px rgba(0,0,0,0.08); margin-bottom:25px;">
        <h3 style="margin-bottom:15px;">üìä Courbe de croissance sur 12 mois</h3>
        <canvas id="simulationChart" height="80"></canvas>
    </div>

    {# Tableau #}
    <div style="background:#fff; border-radius:16px; padding:25px; box-shadow:0 4px 15px rgba(0,0,0,0.08);">
        <h3 style="margin-bottom:15px;">üìã D√©tail mois par mois</h3>
        <table style="width:100%; border-collapse:collapse;">
            <tr style="background:#f9fafb;">
                <th style="padding:12px; text-align:left;">Mois</th>
                <th style="padding:12px; text-align:left;">Total patients √† risque</th>
                <th style="padding:12px; text-align:left;">dont CRITIQUE</th>
                <th style="padding:12px; text-align:left;">dont √âLEV√â</th>
                <th style="padding:12px; text-align:left;">Alerte</th>
            </tr>
            {% for s in simulation %}
            <tr style="{{ loop.index is odd ? 'background:#f9fafb;' : '' }}">
                <td style="padding:12px; font-weight:700;">Mois {{ s.mois }}</td>
                <td style="padding:12px; font-weight:700; color:#F82239;">{{ s.valeur }}</td>
                <td style="padding:12px; color:#dc2626;">{{ s.critique }}</td>
                <td style="padding:12px; color:#ea580c;">{{ s.eleve }}</td>
                <td style="padding:12px;">
                    {% if s.valeur > y0 * 2 %}
                        <span style="background:#fee2e2; color:#dc2626; padding:4px 10px; border-radius:999px; font-size:12px; font-weight:700;">
                            üö® Surcharge critique
                        </span>
                    {% elseif s.valeur > y0 * 1.5 %}
                        <span style="background:#ffedd5; color:#ea580c; padding:4px 10px; border-radius:999px; font-size:12px; font-weight:700;">
                            ‚ö†Ô∏è Surcharge √©lev√©e
                        </span>
                    {% else %}
                        <span style="background:#dcfce7; color:#16a34a; padding:4px 10px; border-radius:999px; font-size:12px; font-weight:700;">
                            ‚úÖ G√©rable
                        </span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </table>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
    const ctx = document.getElementById('simulationChart').getContext('2d');
    const simulation = {{ simulation|json_encode|raw }};

    const labels = simulation.map(s => 'Mois ' + s.mois);
    const total = simulation.map(s => s.valeur);
    const critique = simulation.map(s => s.critique);
    const eleve = simulation.map(s => s.eleve);

    new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Total patients √† risque',
                    data: total,
                    borderColor: '#F82239',
                    backgroundColor: 'rgba(248,34,57,0.1)',
                    fill: true,
                    tension: 0.4
                },
                {
                    label: 'dont CRITIQUE',
                    data: critique,
                    borderColor: '#dc2626',
                    borderDash: [5, 5],
                    fill: false,
                    tension: 0.4
                },
                {
                    label: 'dont √âLEV√â',
                    data: eleve,
                    borderColor: '#ea580c',
                    borderDash: [5, 5],
                    fill: false,
                    tension: 0.4
                }
            ]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { position: 'top' }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: { display: true, text: 'Nombre de patients' }
                }
            }
        }
    });
    </script>

</div>
{% endblock %}