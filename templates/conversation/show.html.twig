{% extends 'base.html.twig' %}

{% block title %}
  Conversation - CardioLink
{% endblock %}

{% block body %}
  <div class="container mt-5">
    <a href="{{ path('app_conversation_index') }}" class="btn btn-secondary mb-3">â† Retour</a>

    <h1 class="mb-4">
      Conversation avec{% if app.user == conversation.patient %}
        Dr. {{ conversation.medecin.prenom }} {{ conversation.medecin.nom }}
      {% else %}
        {{ conversation.patient.prenom }} {{ conversation.patient.nom }}
      {% endif %}
    </h1>

    {# Zone des messages #}
    <div class="card" style="height: 500px; overflow-y: auto; background-color: var(--bg-primary);" id="chat-box">
      <div class="card-body" id="messages-list" style="padding: 1.5rem;">
        {% for message in messages %}
          {# On vÃ©rifie si c'est MOI ou l'AUTRE pour l'alignement #}
        {% set isMe = message.sender == app.user %}
        
        <div class="chat-message {{ isMe ? 'me' : 'other' }} message-container" data-message-id="{{ message.id }}">
            <div class="message-bubble {{ isMe ? 'me' : 'other' }}">
                {% if not isMe %}
                    <span class="message-sender">{{ message.sender.prenom }}</span>
                {% endif %}
                
                <div class="message-content">{{ message.content }}</div>
                
                <div class="message-time">
                    {{ message.createdAt|date('H:i') }}
                    {% if isMe %}
                        <span class="message-status {{ message.isRead ? 'read' : 'sent' }}"></span>
                    {% endif %}
                    {% if message.classification == 'URGENT' %}
                    <small class="badge bg-danger message-badge">| âš ï¸ URGENT</small>
                {% elseif message.classification == 'ADMINISTRATIF' %}
                    <small class="badge bg-info message-badge">| ğŸ“„ Admin</small>
                {% elseif message.classification == 'NORMAL' %}
                    <small class="badge bg-info message-badge">| ğŸŸ¢ Normal</small>
                {% endif %}
                </div>
            </div>

            {# Affichage des rÃ©actions #}
            <div class="message-reactions" data-message-id="{{ message.id }}">
                {% for emoji, reactions in message.reactions|group_by('emoji') %}
                    {% set count = reactions|length %}
                    <button class="reaction-btn" data-emoji="{{ emoji }}">
                        {{ emoji }} <span class="reaction-count">{{ count }}</span>
                    </button>
                {% endfor %}
                
                {# Bouton + pour ajouter une rÃ©action #}
                <button class="add-reaction-btn" title="Ajouter une rÃ©action">
                    â•
                </button>
            </div>

            {# SÃ©lecteur d'emoji #}
            <div class="emoji-picker" style="display: none;">
                <div class="emoji-grid">
                    <span class="emoji" data-emoji="ğŸ‘">ğŸ‘</span>
                    <span class="emoji" data-emoji="â¤ï¸">â¤ï¸</span>
                    <span class="emoji" data-emoji="ğŸ˜‚">ğŸ˜‚</span>
                    <span class="emoji" data-emoji="ğŸ˜®">ğŸ˜®</span>
                    <span class="emoji" data-emoji="ğŸ˜¢">ğŸ˜¢</span>
                    <span class="emoji" data-emoji="ğŸ”¥">ğŸ”¥</span>
                    <span class="emoji" data-emoji="ğŸ‘">ğŸ‘</span>
                    <span class="emoji" data-emoji="âœ¨">âœ¨</span>
                    <span class="emoji" data-emoji="ğŸ’¯">ğŸ’¯</span>
                    <span class="emoji" data-emoji="ğŸ‰">ğŸ‰</span>
                </div>
            </div>
        </div>
        {% endfor %}
      </div>
    </div>

    {# Zone de saisie #}
    <div class="mt-3" style="position: relative; z-index: 100;">
      <div class="input-group position-relative">
        <textarea class="form-control" placeholder="Votre message..." rows="2" id="messageContent"></textarea>
        <button class="btn btn-primary" id="sendBtn">Envoyer â¤</button>
      </div>
      {# Liste des suggestions d'autocomplÃ©tion #}
      <div id="suggestions-list" class="suggestion-dropdown" style="display: none; position: absolute; bottom: 100%; left: 0; right: 0; width: 100%; max-width: 100%;"></div>
    </div>
  </div>

  <style>
    .suggestion-dropdown {
      background: white;
      border: 1px solid #ddd;
      border-radius: 4px;
      max-height: 200px;
      overflow-y: auto;
      z-index: 1050 !important;
      box-shadow: 0 -2px 8px rgba(0,0,0,0.15);
      margin-top: -2px;
    }

    .suggestion-item {
      padding: 12px 15px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
      transition: background-color 0.15s ease;
      font-size: 14px;
    }

    .suggestion-item:last-child {
      border-bottom: none;
    }

    .suggestion-item:hover,
    .suggestion-item.active {
      background-color: #f0f8ff;
      border-left: 3px solid #0d6efd;
      padding-left: 12px;
    }

    .suggestion-highlight {
      font-weight: 600;
      color: #0d6efd;
    }

    /* === STYLES RÃ‰ACTIONS === */
    .message-reactions {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 8px;
      align-items: center;
    }

    .reaction-btn {
      background: #f0f0f0;
      border: 1px solid #ddd;
      border-radius: 16px;
      padding: 4px 10px;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .reaction-btn:hover {
      background: #e0e0e0;
      border-color: #999;
    }

    .reaction-btn.active {
      background: #d4edff;
      border-color: #0d6efd;
    }

    .reaction-count {
      font-size: 11px;
      font-weight: 500;
    }

    .add-reaction-btn {
      background: transparent;
      border: 1px dashed #ccc;
      border-radius: 16px;
      padding: 4px 10px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .add-reaction-btn:hover {
      border-color: #0d6efd;
      background: #f0f8ff;
    }

    .emoji-picker {
      background: white;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-top: 8px;
      z-index: 1000;
      max-width: 250px;
    }

    .emoji-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 8px;
    }

    .emoji {
      font-size: 24px;
      cursor: pointer;
      transition: transform 0.2s ease;
      user-select: none;
      border-radius: 4px;
      padding: 4px;
    }

    .emoji:hover {
      transform: scale(1.2);
      background: #f0f0f0;
    }

    .message-container:hover .add-reaction-btn {
      opacity: 1;
    }

    .message-container:not(:hover) .add-reaction-btn {
      opacity: 0.5;
    }
  </style>     

  {# --- SCRIPT WEBSOCKET & AJAX --- #}
<script>
(function() { // 1. On ouvre une "bulle" isolÃ©e (IIFE) pour Ã©viter l'erreur "Already declared"
    
    const conversationId = {{ conversation.id }};
    const currentUserId = {{ app.user.id }};
    const currentUserPrenom = "{{ app.user.prenom }}";
    
    // 2. Connexion au WebSocket
    let socket = new WebSocket("ws://localhost:3001");

    socket.onopen = function(e) {
        console.log("âœ… ConnectÃ© au serveur de chat !");
    };

    socket.onmessage = function(event) {
        const data = JSON.parse(event.data);
        // On n'affiche le message que s'il appartient Ã  CETTE conversation
        if (data.conversationId === conversationId) {
            // Si c'est moi qui l'ai envoyÃ©, on l'a dÃ©jÃ  affichÃ© via AJAX, donc on ignore
            if (data.senderId !== currentUserId) {
                appendMessage(data.content, false, data.senderPrenom || 'Dr.', data.time, data.classification);
            }
        }
    };

    // 3. Gestion intelligente de la fermeture (Pour Turbo)
    // Quand l'utilisateur quitte la page, on coupe la connexion pour Ã©viter les doublons
    document.addEventListener('turbo:before-cache', function() {
        if (socket) {
            socket.close();
        }
    }, { once: true });

    // 4. Envoi du message
    const sendBtn = document.getElementById('sendBtn');
    const msgInput = document.getElementById('messageContent');
    const suggestionsList = document.getElementById('suggestions-list');

    // === AUTOCOMPLÃ‰TION ===
    let selectedSuggestionIndex = -1;
    let currentSuggestions = [];

    if (msgInput) {
        // RÃ©cupÃ©rer les suggestions
        msgInput.addEventListener('input', debounce(async function() {
            const input = msgInput.value.trim();
            
            console.log('ğŸ” Input:', input, 'Length:', input.length);
            
            if (input.length < 2) {
                suggestionsList.style.display = 'none';
                console.log('âŒ Input trop court');
                return;
            }

            try {
                const url = "{{ path('app_conversation_suggestions', {id: conversation.id}) }}";
                console.log('ğŸ“¡ Fetch URL:', url);
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ input: input })
                });

                console.log('âœ… Response status:', response.status);
                
                const data = await response.json();
                console.log('ğŸ“¦ Response data:', data);
                
                currentSuggestions = data.suggestions || [];
                selectedSuggestionIndex = -1;

                console.log('ğŸ’¡ Suggestions reÃ§ues:', currentSuggestions.length, currentSuggestions);

                if (currentSuggestions.length > 0) {
                    displaySuggestions(input);
                } else {
                    suggestionsList.style.display = 'none';
                    console.log('âš ï¸ Aucune suggestion trouvÃ©e');
                }
            } catch (error) {
                console.error('âŒ Erreur autocomplÃ©tion:', error);
            }
        }, 300));

        // Navigation au clavier
        msgInput.addEventListener('keydown', function(e) {
            if (suggestionsList.style.display === 'none') return;

            if (e.key === 'ArrowDown') {
                e.preventDefault();
                selectedSuggestionIndex = Math.min(selectedSuggestionIndex + 1, currentSuggestions.length - 1);
                updateSuggestionSelection();
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                selectedSuggestionIndex = Math.max(selectedSuggestionIndex - 1, -1);
                updateSuggestionSelection();
            } else if (e.key === 'Enter' && selectedSuggestionIndex !== -1) {
                e.preventDefault();
                selectSuggestion(currentSuggestions[selectedSuggestionIndex]);
            } else if (e.key === 'Escape') {
                suggestionsList.style.display = 'none';
            }
        });
    }

    function displaySuggestions(input) {
        suggestionsList.innerHTML = '';
        currentSuggestions.forEach((suggestion, index) => {
            const item = document.createElement('div');
            item.className = 'suggestion-item';
            
            // Surligner la partie qui correspond Ã  l'input
            const inputLower = input.toLowerCase();
            const suggestionLower = suggestion.toLowerCase();
            const matchIndex = suggestionLower.indexOf(inputLower);
            
            let highlightedText = suggestion;
            if (matchIndex !== -1) {
                const before = suggestion.substring(0, matchIndex);
                const match = suggestion.substring(matchIndex, matchIndex + input.length);
                const after = suggestion.substring(matchIndex + input.length);
                highlightedText = `${before}<span class="suggestion-highlight">${match}</span>${after}`;
            }
            
            item.innerHTML = highlightedText;
            item.addEventListener('click', () => selectSuggestion(suggestion));
            item.addEventListener('mouseenter', () => {
                selectedSuggestionIndex = index;
                updateSuggestionSelection();
            });
            
            suggestionsList.appendChild(item);
        });
        suggestionsList.style.display = 'block';
    }

    function updateSuggestionSelection() {
        const items = suggestionsList.querySelectorAll('.suggestion-item');
        items.forEach((item, index) => {
            item.classList.toggle('active', index === selectedSuggestionIndex);
        });
    }

    function selectSuggestion(suggestion) {
        msgInput.value = suggestion + ' ';
        suggestionsList.style.display = 'none';
        msgInput.focus();
        msgInput.setSelectionRange(msgInput.value.length, msgInput.value.length);
        selectedSuggestionIndex = -1;
    }

    // Fonction debounce pour limiter les appels API
    function debounce(func, delay) {
        let timeoutId;
        return function(...args) {
            clearTimeout(timeoutId);
            timeoutId = setTimeout(() => func(...args), delay);
        };
    }

    // Fermer les suggestions quand on clique ailleurs
    document.addEventListener('click', function(e) {
        if (msgInput && suggestionsList) {
            const isClickInTextarea = msgInput.contains(e.target);
            const isClickInSuggestions = suggestionsList.contains(e.target);
            
            if (!isClickInTextarea && !isClickInSuggestions) {
                console.log('ğŸ”š Fermeture des suggestions');
                suggestionsList.style.display = 'none';
            }
        }
    });

    // === FIN AUTOCOMPLÃ‰TION ===

    if (sendBtn && msgInput) {
        sendBtn.addEventListener('click', sendMessage);

        msgInput.addEventListener('keypress', function (e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
    }

    function sendMessage() {
        const content = msgInput.value.trim();
        if (!content) return;

        // A. Sauvegarde en BDD (AJAX)
        fetch("{{ path('app_conversation_send', {id: conversation.id}) }}", {
            method: "POST",
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ content: content })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // B. Affichage pour MOI
                

                // C. Diffusion WebSocket
                if (socket.readyState === WebSocket.OPEN) {
                    const payload = {
                    conversationId: conversationId,
                    content: content,
                    senderId: currentUserId,
                    senderPrenom: currentUserPrenom,
                    
                    // ğŸ‘‡ Important pour que l'autre personne voie la couleur
                    classification: data.classification, 
                    
                    time: data.createdAt
                };
                appendMessage(content, true, 'Moi', data.createdAt, data.classification);
                msgInput.value = '';
                suggestionsList.style.display = 'none';
                    socket.send(JSON.stringify(payload));
                }
            }
        })
        .catch(error => console.error('Erreur:', error));
    }

    // Fonction d'affichage HTML
    // Fonction d'affichage mise Ã  jour avec la classe 'message-status'
    function appendMessage(text, isMe, senderName, time, classification) {
        const list = document.getElementById('messages-list');
        if (!list) return;

        let badgeHtml = '';
        if (classification === 'URGENT') {
            badgeHtml = '<small class="badge bg-danger message-badge">âš ï¸ URGENT</small>';
        } else if (classification === 'ADMINISTRATIF') {
            badgeHtml = '<small class="badge bg-info message-badge">ğŸ“„ Admin</small>';
        }else if (classification === 'NORMAL'){
            badgeHtml = '<small class="badge bg-info message-badge">ğŸŸ¢ Normal</small>';
        }

        const senderDisplay = isMe ? '' : `<span class="message-sender">${senderName}</span>`;
        const statusHtml = isMe ? '<span class="message-status sent"></span>' : '';

        const html = `
            <div class="chat-message ${isMe ? 'me' : 'other'} message-container" data-message-id="">
                <div class="message-bubble ${isMe ? 'me' : 'other'}">
                    ${senderDisplay}
                    <div class="message-content">${text}</div>
                    <div class="message-time">${time}${statusHtml} | ${badgeHtml}</div>
                </div>
                <div class="message-reactions" data-message-id="">
                    <button class="add-reaction-btn" title="Ajouter une rÃ©action">â•</button>
                    <div class="emoji-picker" style="display: none;">
                        <div class="emoji-grid">
                            <span class="emoji" data-emoji="ğŸ‘">ğŸ‘</span>
                            <span class="emoji" data-emoji="â¤ï¸">â¤ï¸</span>
                            <span class="emoji" data-emoji="ğŸ˜‚">ğŸ˜‚</span>
                            <span class="emoji" data-emoji="ğŸ˜®">ğŸ˜®</span>
                            <span class="emoji" data-emoji="ğŸ˜¢">ğŸ˜¢</span>
                            <span class="emoji" data-emoji="ğŸ”¥">ğŸ”¥</span>
                            <span class="emoji" data-emoji="ğŸ‘">ğŸ‘</span>
                            <span class="emoji" data-emoji="âœ¨">âœ¨</span>
                            <span class="emoji" data-emoji="ğŸ’¯">ğŸ’¯</span>
                            <span class="emoji" data-emoji="ğŸ‰">ğŸ‰</span>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        list.insertAdjacentHTML('beforeend', html);
        const chatBox = document.getElementById('chat-box');
        if (chatBox) chatBox.scrollTop = chatBox.scrollHeight;
        
        // Attacher les Ã©vÃ©nements aux rÃ©actions du nouveau message
        attachReactionEvents(list.lastElementChild);
    }

    // === GESTION DES RÃ‰ACTIONS ===
    function attachReactionEvents(messageElement) {
        const addBtn = messageElement.querySelector('.add-reaction-btn');
        const emojiPicker = messageElement.querySelector('.emoji-picker');
        const emojis = messageElement.querySelectorAll('.emoji');
        const messageContainer = messageElement;

        if (addBtn) {
            addBtn.addEventListener('click', function() {
                emojiPicker.style.display = emojiPicker.style.display === 'none' ? 'block' : 'none';
            });
        }

        emojis.forEach(emoji => {
            emoji.addEventListener('click', function() {
                const selectedEmoji = this.getAttribute('data-emoji');
                addReaction(messageContainer, selectedEmoji);
                emojiPicker.style.display = 'none';
            });
        });
    }

    function addReaction(messageElement, emoji) {
        const messageId = messageElement.getAttribute('data-message-id');
        
        if (!messageId) {
            console.warn('âŒ Message ID non trouvÃ©');
            return;
        }

        fetch("{{ path('app_message_react', {id: 'DUMMY'}) }}".replace('DUMMY', messageId), {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ emoji: emoji })
        })
        .then(response => response.json())
        .then(data => {
            console.log('ğŸ˜Š RÃ©action:', data);
            
            if (data.status === 'added' || data.status === 'removed') {
                updateReactionsDisplay(messageElement, data.reactions);
            }
        })
        .catch(error => console.error('âŒ Erreur rÃ©action:', error));
    }

    function updateReactionsDisplay(messageElement, reactions) {
        const reactionsContainer = messageElement.querySelector('.message-reactions');
        
        // RÃ©crÃ©er l'affichage des rÃ©actions
        let reactionsHtml = '';
        reactions.forEach(reaction => {
            const isActive = reaction.hasReacted ? ' active' : '';
            reactionsHtml += `<button class="reaction-btn${isActive}" data-emoji="${reaction.emoji}">
                ${reaction.emoji} <span class="reaction-count">${reaction.count}</span>
            </button>`;
        });

        // Ajouter le bouton +
        reactionsHtml += `<button class="add-reaction-btn" title="Ajouter une rÃ©action">â•</button>
            <div class="emoji-picker" style="display: none;">
                <div class="emoji-grid">
                    <span class="emoji" data-emoji="ğŸ‘">ğŸ‘</span>
                    <span class="emoji" data-emoji="â¤ï¸">â¤ï¸</span>
                    <span class="emoji" data-emoji="ğŸ˜‚">ğŸ˜‚</span>
                    <span class="emoji" data-emoji="ğŸ˜®">ğŸ˜®</span>
                    <span class="emoji" data-emoji="ğŸ˜¢">ğŸ˜¢</span>
                    <span class="emoji" data-emoji="ğŸ”¥">ğŸ”¥</span>
                    <span class="emoji" data-emoji="ğŸ‘">ğŸ‘</span>
                    <span class="emoji" data-emoji="âœ¨">âœ¨</span>
                    <span class="emoji" data-emoji="ğŸ’¯">ğŸ’¯</span>
                    <span class="emoji" data-emoji="ğŸ‰">ğŸ‰</span>
                </div>
            </div>`;

        reactionsContainer.innerHTML = reactionsHtml;
        
        // RÃ©attacher les Ã©vÃ©nements
        attachReactionEvents(messageElement);
    }

    // Attacher les Ã©vÃ©nements Ã  tous les messages au chargement
    document.querySelectorAll('.message-container').forEach(messageElement => {
        attachReactionEvents(messageElement);
    });
    
    // Scroll au chargement
    const chatBox = document.getElementById('chat-box');
    if (chatBox) chatBox.scrollTop = chatBox.scrollHeight;
})(); // <--- Fin de l'isolation
</script>
{% endblock %}