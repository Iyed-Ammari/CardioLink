{% extends 'patient/base.html.twig' %}
{% block title %}Mes commandes{% endblock %}
{% block page_title %}Mes commandes{% endblock %}

{% block styles %}
<style>
  @import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700;800;900&family=DM+Mono:wght@400;500&display=swap');

  :root {
    --red: #F82239;
    --blue: #2F60F5;
    --grad: linear-gradient(135deg, #F82239, #2F60F5);
    --grad-soft: linear-gradient(135deg, rgba(248,34,57,.06), rgba(47,96,245,.06));
  }

  /* ===== Liste ===== */
  .orders-list { display: flex; flex-direction: column; gap: 12px; }

  .order-card {
    background: #fff;
    border: 1.5px solid rgba(229,231,235,.8);
    border-radius: 18px;
    padding: 16px 20px;
    box-shadow: 0 2px 12px rgba(16,24,40,.04);
    display: flex;
    gap: 14px;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    transition: all .2s ease;
    font-family: 'DM Sans', sans-serif;
  }
  .order-card:hover {
    box-shadow: 0 6px 24px rgba(16,24,40,.08);
    border-color: rgba(47,96,245,.2);
    transform: translateY(-1px);
  }

  .order-left { display: flex; flex-direction: column; gap: 5px; min-width: 160px; }
  .order-id   { font-size: 15px; font-weight: 800; color: #111827; letter-spacing: -.2px; }
  .order-meta { font-size: 12px; font-weight: 600; color: #9CA3AF; }
  .order-amount { font-weight: 800; color: #111827; font-size: 13px; }

  /* Badges */
  .badge {
    display: inline-flex; align-items: center; gap: 5px;
    padding: 7px 13px; border-radius: 999px;
    font-size: 12px; font-weight: 700; border: 1.5px solid;
    white-space: nowrap; font-family: 'DM Sans', sans-serif;
  }
  .badge-panier  { background: rgba(47,96,245,.07);  color: #1D4ED8; border-color: rgba(47,96,245,.2); }
  .badge-payee   { background: rgba(13,148,136,.07); color: #0F766E; border-color: rgba(13,148,136,.2); }
  .badge-livree  { background: rgba(16,185,129,.07); color: #065F46; border-color: rgba(16,185,129,.2); }
  .badge-annulee { background: rgba(248,34,57,.07);  color: #B42318; border-color: rgba(248,34,57,.2); }

  /* Badge EN_ATTENTE cliquable */
  .badge-attente-btn {
    display: inline-flex; align-items: center; gap: 7px;
    padding: 8px 16px; border-radius: 999px;
    font-size: 12px; font-weight: 800;
    border: 1.5px solid rgba(245,158,11,.35);
    background: rgba(245,158,11,.08); color: #92400E;
    cursor: pointer; transition: all .2s ease; white-space: nowrap;
    position: relative; overflow: hidden;
    font-family: 'DM Sans', sans-serif;
  }
  .badge-attente-btn::after {
    content: 'ğŸ’³ Cliquer pour payer';
    position: absolute; inset: 0;
    background: var(--grad);
    color: #fff; display: flex; align-items: center; justify-content: center;
    font-size: 12px; font-weight: 800; opacity: 0; transition: opacity .2s ease; border-radius: 999px;
  }
  .badge-attente-btn:hover::after { opacity: 1; }
  .badge-attente-btn:hover { border-color: transparent; transform: scale(1.02); box-shadow: 0 6px 20px rgba(47,96,245,.25); }
  .pulse-dot {
    width: 7px; height: 7px; border-radius: 50%; background: #F59E0B;
    animation: pulse-anim 1.5s ease-in-out infinite; flex-shrink: 0;
  }
  @keyframes pulse-anim { 0%,100%{transform:scale(1);opacity:1} 50%{transform:scale(1.4);opacity:.6} }

  /* Bouton tÃ©lÃ©charger facture */
  .btn-facture {
    height: 36px; padding: 0 14px; border-radius: 10px;
    border: 1.5px solid rgba(47,96,245,.25);
    background: rgba(47,96,245,.06); color: #1D4ED8;
    font-weight: 700; font-size: 12px; cursor: pointer;
    transition: .15s ease; text-decoration: none;
    display: inline-flex; align-items: center; gap: 5px;
    font-family: 'DM Sans', sans-serif;
  }
  .btn-facture:hover { background: rgba(47,96,245,.12); transform: translateY(-1px); }

  .order-actions { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }

  .btn-cancel {
    height: 36px; padding: 0 12px; border-radius: 10px;
    border: 1.5px solid rgba(248,34,57,.2); background: rgba(248,34,57,.05);
    color: #B42318; font-weight: 700; font-size: 12px; cursor: pointer; transition: .15s ease;
    font-family: 'DM Sans', sans-serif;
  }
  .btn-cancel:hover { background: rgba(248,34,57,.1); }

  .empty-state { text-align: center; padding: 52px 20px; color: #D1D5DB; }
  .empty-state .icon { font-size: 44px; margin-bottom: 10px; }
  .empty-state .msg  { font-weight: 800; font-size: 15px; color: #9CA3AF; }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MODAL PAIEMENT
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .modal-overlay {
    display: none; position: fixed; inset: 0;
    background: rgba(8,8,20,.6); backdrop-filter: blur(8px);
    z-index: 9998; align-items: center; justify-content: center; padding: 16px;
  }
  .modal-overlay.open { display: flex; }

  .modal {
    background: #fff; border-radius: 28px;
    width: min(520px, 100%);
    box-shadow: 0 0 0 1px rgba(0,0,0,.06), 0 40px 80px rgba(0,0,0,.22);
    position: relative; overflow: hidden;
    animation: modalIn .25s cubic-bezier(.34,1.4,.64,1);
    max-height: 95vh; overflow-y: auto;
    font-family: 'DM Sans', sans-serif;
  }
  @keyframes modalIn { from{opacity:0;transform:scale(.9) translateY(-20px)} to{opacity:1;transform:scale(1) translateY(0)} }

  .modal-hero {
    background: var(--grad); padding: 28px 28px 24px;
    position: relative; overflow: hidden;
  }
  .modal-hero::before {
    content:''; position:absolute; top:-40px; right:-40px;
    width:160px; height:160px; border-radius:50%; background:rgba(255,255,255,.08);
  }
  .modal-hero::after {
    content:''; position:absolute; bottom:-30px; left:30px;
    width:100px; height:100px; border-radius:50%; background:rgba(255,255,255,.06);
  }
  .modal-close {
    position:absolute; top:14px; right:14px; border:none;
    background:rgba(255,255,255,.2); width:34px; height:34px; border-radius:50%;
    font-size:18px; cursor:pointer; color:#fff; display:flex;
    align-items:center; justify-content:center; transition:.15s; z-index:2;
  }
  .modal-close:hover { background:rgba(255,255,255,.35); }

  .modal-lock { font-size:28px; margin-bottom:8px; position:relative; z-index:1; }
  .modal-title { font-size:22px; font-weight:900; color:#fff; margin-bottom:4px; position:relative; z-index:1; letter-spacing:-.3px; }
  .modal-sub   { font-size:13px; font-weight:600; color:rgba(255,255,255,.75); position:relative; z-index:1; }

  /* Carte virtuelle */
  .virtual-card {
    background:linear-gradient(135deg,rgba(255,255,255,.25),rgba(255,255,255,.1));
    border:1px solid rgba(255,255,255,.25); border-radius:14px;
    padding:12px 16px; margin-top:16px; position:relative; z-index:1;
  }
  .vc-top { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
  .vc-chip { width:32px; height:24px; border-radius:5px; background:linear-gradient(135deg,#FFD700,#FFA500); box-shadow:0 2px 6px rgba(0,0,0,.2); }
  .vc-brand-display { font-size:13px; font-weight:800; color:rgba(255,255,255,.9); letter-spacing:1px; font-family:'DM Mono',monospace; }
  .vc-number { font-family:'DM Mono',monospace; font-size:15px; font-weight:500; color:rgba(255,255,255,.9); letter-spacing:3px; margin-bottom:8px; }
  .vc-bottom { display:flex; justify-content:space-between; align-items:flex-end; }
  .vc-label { font-size:9px; color:rgba(255,255,255,.55); text-transform:uppercase; letter-spacing:1px; }
  .vc-val   { font-size:12px; color:rgba(255,255,255,.9); font-weight:700; font-family:'DM Mono',monospace; }

  /* Corps modal */
  .modal-body { padding: 24px 28px 28px; }

  .pay-recap {
    background: var(--grad-soft); border:1.5px solid rgba(47,96,245,.12);
    border-radius:14px; padding:14px 18px;
    display:flex; justify-content:space-between; align-items:center; margin-bottom:22px;
  }
  .pay-recap .rl { font-size:12px; font-weight:700; color:#6B7280; text-transform:uppercase; letter-spacing:.5px; }
  .pay-recap .ra { font-size:22px; font-weight:900; color:#111827; letter-spacing:-.5px; }

  /* Modes paiement */
  .payment-methods { display:grid; grid-template-columns:repeat(3,1fr); gap:8px; margin-bottom:20px; }
  .pm-option {
    border:2px solid #E5E7EB; border-radius:12px; padding:10px 8px;
    cursor:pointer; text-align:center; transition:all .15s ease; background:#F9FAFB; position:relative;
  }
  .pm-option:hover { border-color:rgba(47,96,245,.35); background:rgba(47,96,245,.04); }
  .pm-option.selected { border-color:var(--blue); background:rgba(47,96,245,.06); box-shadow:0 0 0 3px rgba(47,96,245,.12); }
  .pm-option.selected::after {
    content:'âœ“'; position:absolute; top:-7px; right:-7px;
    width:18px; height:18px; border-radius:50%; background:var(--blue); color:#fff;
    font-size:10px; font-weight:900; display:flex; align-items:center; justify-content:center;
  }
  .pm-logo { font-size:11px; font-weight:900; letter-spacing:.5px; color:#374151; margin-bottom:3px; }
  .pm-logo.visa-logo  { color:#1A1F71; font-size:14px; font-style:italic; }
  .pm-logo.mc-logo    { color:#EB001B; }
  .pm-logo.amex-logo  { color:#006FCF; }
  .pm-sub { font-size:9px; color:#9CA3AF; font-weight:600; }

  .form-section-title { font-size:11px; font-weight:800; color:#9CA3AF; text-transform:uppercase; letter-spacing:1px; margin-bottom:12px; margin-top:4px; }
  .divider-line { height:1px; background:#F3F4F6; margin:16px 0; }

  .form-field { display:flex; flex-direction:column; gap:5px; margin-bottom:12px; }
  .form-field label { font-size:12px; font-weight:800; color:#374151; letter-spacing:.1px; }
  .form-field input {
    height:46px; border-radius:11px; border:1.5px solid #E5E7EB; padding:0 14px;
    font-size:14px; font-weight:700; color:#111827; outline:none; transition:.15s ease;
    background:#FAFAFA; font-family:'DM Sans',sans-serif; width:100%; box-sizing:border-box;
  }
  .form-field input[data-mono] { font-family:'DM Mono',monospace; letter-spacing:1px; }
  .form-field input::placeholder { color:#C4C9D4; font-weight:500; }
  .form-field input:focus { border-color:rgba(47,96,245,.5); box-shadow:0 0 0 3px rgba(47,96,245,.10); background:#fff; }
  .form-field input.is-error { border-color:rgba(248,34,57,.5); box-shadow:0 0 0 3px rgba(248,34,57,.08); }
  .field-err { font-size:11.5px; font-weight:700; color:#DC2626; display:none; align-items:center; gap:4px; }
  .field-err.show { display:flex; }
  .field-err::before { content:'âš '; font-size:10px; }

  .form-row   { display:grid; grid-template-columns:1fr 1fr; gap:10px; }

  .form-field select {
    height:46px; border-radius:11px; border:1.5px solid #E5E7EB; padding:0 14px;
    font-size:14px; font-weight:700; color:#111827; outline:none; transition:.15s ease;
    background:#FAFAFA url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath fill='%239CA3AF' d='M1 1l5 5 5-5'/%3E%3C/svg%3E") no-repeat right 12px center;
    appearance:none; font-family:'DM Sans',sans-serif; cursor:pointer;
    padding-right:32px; width:100%; box-sizing:border-box;
  }
  .form-field select:focus { border-color:rgba(47,96,245,.5); box-shadow:0 0 0 3px rgba(47,96,245,.10); background-color:#fff; }
  .form-field select.is-error { border-color:rgba(248,34,57,.5); box-shadow:0 0 0 3px rgba(248,34,57,.08); }

  .global-err {
    background:rgba(248,34,57,.06); border:1.5px solid rgba(248,34,57,.2); border-radius:10px;
    padding:11px 14px; font-size:12.5px; font-weight:700; color:#DC2626; margin-bottom:14px;
    display:none; align-items:center; gap:8px;
  }
  .global-err.show { display:flex; }
  .global-err::before { content:'âŒ'; font-size:14px; }

  .test-hint {
    background:rgba(47,96,245,.05); border:1px dashed rgba(47,96,245,.25);
    border-radius:10px; padding:10px 14px; font-size:11.5px; color:#4B5563;
    margin-bottom:16px; font-weight:600; line-height:1.6;
  }
  .test-hint strong { color:#1D4ED8; font-family:'DM Mono',monospace; }

  .btn-submit-pay {
    width:100%; height:52px; border-radius:14px; border:none; background:var(--grad);
    color:#fff; font-size:15px; font-weight:800; cursor:pointer;
    box-shadow:0 10px 28px rgba(248,34,57,.25),0 4px 12px rgba(47,96,245,.2);
    transition:.15s ease; display:flex; align-items:center; justify-content:center;
    gap:8px; font-family:'DM Sans',sans-serif; margin-top:4px;
  }
  .btn-submit-pay:hover   { opacity:.92; transform:translateY(-1px); }
  .btn-submit-pay:disabled { opacity:.55; cursor:not-allowed; transform:none; box-shadow:none; }

  .spinner {
    width:18px; height:18px; border:2.5px solid rgba(255,255,255,.3);
    border-top-color:#fff; border-radius:50%; animation:spin .7s linear infinite; display:none; flex-shrink:0;
  }
  @keyframes spin { to{transform:rotate(360deg)} }

  .security-row {
    display:flex; align-items:center; justify-content:center; gap:14px;
    margin-top:14px; padding-top:14px; border-top:1px solid #F3F4F6;
  }
  .sec-item { display:flex; align-items:center; gap:4px; font-size:10.5px; font-weight:700; color:#9CA3AF; }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MODAL SUCCÃˆS PAIEMENT (nouvelle alerte)
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .success-overlay {
    display: none; position: fixed; inset: 0;
    background: rgba(8,8,20,.65); backdrop-filter: blur(10px);
    z-index: 9999; align-items: center; justify-content: center; padding: 16px;
  }
  .success-overlay.open { display: flex; }

  .success-modal {
    background: #fff; border-radius: 28px;
    width: min(460px, 100%);
    box-shadow: 0 0 0 1px rgba(0,0,0,.06), 0 40px 80px rgba(0,0,0,.25);
    overflow: hidden; animation: modalIn .3s cubic-bezier(.34,1.4,.64,1);
    font-family: 'DM Sans', sans-serif;
  }

  /* Header vert du succÃ¨s */
  .success-hero {
    background: linear-gradient(135deg, #10B981, #059669);
    padding: 36px 28px 28px;
    text-align: center;
    position: relative;
    overflow: hidden;
  }
  .success-hero::before {
    content:''; position:absolute; top:-50px; right:-50px;
    width:180px; height:180px; border-radius:50%; background:rgba(255,255,255,.08);
  }
  .success-hero::after {
    content:''; position:absolute; bottom:-40px; left:-20px;
    width:120px; height:120px; border-radius:50%; background:rgba(255,255,255,.06);
  }

  .success-icon-ring {
    width: 80px; height: 80px; border-radius: 50%;
    background: rgba(255,255,255,.2); border: 3px solid rgba(255,255,255,.4);
    display: flex; align-items: center; justify-content: center;
    margin: 0 auto 16px;
    font-size: 36px;
    animation: popIn .4s cubic-bezier(.34,1.56,.64,1);
    position: relative; z-index: 1;
    box-shadow: 0 0 0 12px rgba(255,255,255,.1);
  }
  @keyframes popIn { from{transform:scale(0)} to{transform:scale(1)} }

  .success-title {
    font-size: 24px; font-weight: 900; color: #fff;
    margin-bottom: 6px; letter-spacing: -.4px;
    position: relative; z-index: 1;
  }
  .success-sub {
    font-size: 13px; font-weight: 600; color: rgba(255,255,255,.8);
    line-height: 1.6; position: relative; z-index: 1;
  }

  /* RÃ©cap paiement dans la success modal */
  .success-body { padding: 24px 28px 28px; }

  .success-recap {
    background: #F9FAFB; border-radius: 14px; padding: 16px 18px; margin-bottom: 20px;
  }
  .recap-row {
    display: flex; justify-content: space-between; align-items: center;
    padding: 6px 0; border-bottom: 1px solid #F3F4F6;
  }
  .recap-row:last-child { border-bottom: none; }
  .recap-label { font-size: 12px; font-weight: 600; color: #6B7280; }
  .recap-value { font-size: 13px; font-weight: 800; color: #111827; }
  .recap-value.amount {
    font-size: 18px; font-weight: 900; color: #10B981;
  }

  /* Boutons succÃ¨s */
  .success-actions { display: flex; flex-direction: column; gap: 10px; }

  .btn-download-pdf {
    width: 100%; height: 52px; border-radius: 14px; border: none;
    background: linear-gradient(135deg, #10B981, #059669);
    color: #fff; font-size: 15px; font-weight: 800; cursor: pointer;
    box-shadow: 0 10px 28px rgba(16,185,129,.3);
    transition: .15s ease; display: flex; align-items: center;
    justify-content: center; gap: 10px;
    font-family: 'DM Sans', sans-serif; text-decoration: none;
  }
  .btn-download-pdf:hover { opacity: .9; transform: translateY(-1px); }

  .btn-later {
    width: 100%; height: 46px; border-radius: 12px;
    border: 1.5px solid #E5E7EB; background: #fff;
    color: #6B7280; font-size: 14px; font-weight: 700; cursor: pointer;
    transition: .15s ease; font-family: 'DM Sans', sans-serif;
  }
  .btn-later:hover { border-color: #D1D5DB; color: #374151; }

  /* Badge payÃ© dans la success modal */
  .paid-badge-big {
    display: inline-flex; align-items: center; gap: 6px;
    background: #D1FAE5; color: #065F46;
    border: 1.5px solid #6EE7B7; border-radius: 999px;
    padding: 7px 16px; font-size: 13px; font-weight: 800;
    margin-bottom: 18px;
  }

  /* Confetti animation (optionnel) */
  .confetti-container {
    position: fixed; inset: 0; pointer-events: none; z-index: 10000; overflow: hidden;
  }
  .confetti-piece {
    position: absolute; top: -10px;
    width: 8px; height: 8px; border-radius: 2px;
    animation: confettiFall linear forwards;
  }
  @keyframes confettiFall {
    0%   { transform: translateY(0) rotate(0deg); opacity: 1; }
    100% { transform: translateY(110vh) rotate(720deg); opacity: 0; }
  }
</style>
{% endblock %}

{% block body %}
<div class="card">
  <div class="orders-list">
    {% for c in commandes %}
      <div class="order-card">
        <div class="order-left">
          <div class="order-id">Commande #{{ c.id }}</div>
          <div class="order-meta">
            {{ c.dateCommande ? (c.dateCommande|date('d/m/Y Ã  H:i')) : 'â€”' }}
            &nbsp;Â·&nbsp; {{ c.lignes|length }} article(s)
          </div>
          <div class="order-meta">
            Total : <span class="order-amount">{{ c.montantTotal }} TND</span>
          </div>
        </div>

        <div class="order-actions">
          {% set s = c.statut %}

          {% if s == 'PANIER' %}
            <span class="badge badge-panier">ğŸ›’ Panier</span>

          {% elseif s == 'EN_ATTENTE_PAIEMENT' %}
            <button class="badge-attente-btn" type="button"
              onclick="openPayModal({{ c.id }}, '{{ c.montantTotal }}')"
              title="Cliquer pour payer">
              <span class="pulse-dot"></span>
              â³ En attente paiement
            </button>

          {% elseif s == 'PAYEE' %}
            <span class="badge badge-payee">ğŸ’³ PayÃ©e</span>
            <a class="btn-facture" href="{{ path('patient_commande_facture', {id: c.id}) }}" target="_blank">
              ğŸ“„ Facture PDF
            </a>

          {% elseif s == 'LIVREE' %}
            <span class="badge badge-livree">ğŸ“¦ LivrÃ©e</span>
            <a class="btn-facture" href="{{ path('patient_commande_facture', {id: c.id}) }}" target="_blank">
              ğŸ“„ Facture PDF
            </a>

          {% else %}
            <span class="badge badge-annulee">âŒ AnnulÃ©e</span>
          {% endif %}

          {% if c.statut in ['EN_ATTENTE_PAIEMENT', 'PANIER'] %}
            <form method="post" action="{{ path('patient_commande_cancel', {id: c.id}) }}"
                  style="margin:0;" onsubmit="return confirm('Annuler la commande #{{ c.id }} ?');">
              <button class="btn-cancel" type="submit">Annuler</button>
            </form>
          {% endif %}
        </div>
      </div>
    {% else %}
      <div class="empty-state">
        <div class="icon">ğŸ“‹</div>
        <div class="msg">Aucune commande pour le moment.</div>
      </div>
    {% endfor %}
  </div>

  <div style="margin-top:16px; display:flex; gap:10px; flex-wrap:wrap;">
    <a class="btn btn-ghost" href="{{ path('patient_produit_index') }}">â¬… Retour produits</a>
    <a class="btn btn-ghost" href="{{ path('patient_panier_show') }}">ğŸ›’ Mon panier</a>
  </div>
</div>

{# â•â•â• MODAL PAIEMENT â•â•â• #}
<div class="modal-overlay" id="payModal" onclick="handleOverlayClick(event)">
  <div class="modal">
    <button class="modal-close" onclick="closePayModal()" type="button">Ã—</button>

    <div id="payForm">
      <div class="modal-hero">
        <div class="modal-lock">ğŸ”’</div>
        <div class="modal-title">Paiement sÃ©curisÃ©</div>
        <div class="modal-sub">Commande <span id="modalRef" style="font-weight:800;color:#fff;"></span></div>
        <div class="virtual-card">
          <div class="vc-top">
            <div class="vc-chip"></div>
            <div class="vc-brand-display" id="vcBrand">VISA</div>
          </div>
          <div class="vc-number" id="vcNumber">â€¢â€¢â€¢â€¢  â€¢â€¢â€¢â€¢  â€¢â€¢â€¢â€¢  â€¢â€¢â€¢â€¢</div>
          <div class="vc-bottom">
            <div><div class="vc-label">Titulaire</div><div class="vc-val" id="vcName">VOTRE NOM</div></div>
            <div style="text-align:right"><div class="vc-label">Expire</div><div class="vc-val" id="vcExp">MM/AA</div></div>
          </div>
        </div>
      </div>

      <div class="modal-body">
        <div class="pay-recap">
          <span class="rl">Montant Ã  dÃ©biter</span>
          <span class="ra" id="modalMontant">â€”</span>
        </div>

        <div class="global-err" id="globalErr"></div>

        <div class="test-hint">
          ğŸ’¡ NumÃ©ro de test valide : <strong>4532015112830366</strong> (Visa) Â· CVV : <strong>123</strong>
        </div>

        <div class="form-section-title">Mode de paiement</div>
        <div class="payment-methods">
          <div class="pm-option selected" data-brand="VISA" onclick="selectBrand(this,'VISA')">
            <div class="pm-logo visa-logo">VISA</div><div class="pm-sub">Classique</div>
          </div>
          <div class="pm-option" data-brand="MASTERCARD" onclick="selectBrand(this,'MASTERCARD')">
            <div class="pm-logo mc-logo">â—â— MC</div><div class="pm-sub">Mastercard</div>
          </div>
          <div class="pm-option" data-brand="AMEX" onclick="selectBrand(this,'AMEX')">
            <div class="pm-logo amex-logo">AMEX</div><div class="pm-sub">4 chiffres</div>
          </div>
        </div>

        <div class="divider-line"></div>
        <div class="form-section-title">Informations de la carte</div>

        <div class="form-field">
          <label for="nomCarte">Nom du titulaire *</label>
          <input type="text" id="nomCarte" placeholder="Tel qu'il apparaÃ®t sur la carte"
                 autocomplete="cc-name" maxlength="100" oninput="updateVcName(this.value)">
          <span class="field-err" id="err-nomCarte"></span>
        </div>

        <div class="form-field">
          <label for="numeroCarte">NumÃ©ro de carte *</label>
          <input type="text" id="numeroCarte" data-mono
                 placeholder="Ex: 4532 0151 1283 0366"
                 autocomplete="cc-number" maxlength="19" inputmode="numeric">
          <span class="field-err" id="err-numeroCarte"></span>
        </div>

        <div class="form-row">
          <div class="form-field">
            <label>Date d'expiration *</label>
            <div class="form-row" style="gap:6px;margin:0;">
              <select id="expMois" onchange="updateVcExp()" style="font-size:13px;">
                <option value="">Mois</option>
                <option value="01">01 â€” Jan</option><option value="02">02 â€” FÃ©v</option>
                <option value="03">03 â€” Mar</option><option value="04">04 â€” Avr</option>
                <option value="05">05 â€” Mai</option><option value="06">06 â€” Juin</option>
                <option value="07">07 â€” Juil</option><option value="08">08 â€” AoÃ»t</option>
                <option value="09">09 â€” Sep</option><option value="10">10 â€” Oct</option>
                <option value="11">11 â€” Nov</option><option value="12">12 â€” DÃ©c</option>
              </select>
              <select id="expAnnee" onchange="updateVcExp()" style="font-size:13px;">
                <option value="">AnnÃ©e</option>
                {% for y in range(2026, 2037) %}
                  <option value="{{ y|slice(-2) }}">{{ y }}</option>
                {% endfor %}
              </select>
            </div>
            <span class="field-err" id="err-expiration"></span>
          </div>

          <div class="form-field">
            <label for="cvv">CVV / CVC *</label>
            <input type="text" id="cvv" data-mono
                   placeholder="3 chiffres (dos)" autocomplete="cc-csc" maxlength="4" inputmode="numeric">
            <span class="field-err" id="err-cvv"></span>
          </div>
        </div>

        <button class="btn-submit-pay" id="submitBtn" type="button" onclick="submitPaiement()">
          <span id="btnText">ğŸ”’ Confirmer le paiement</span>
          <div class="spinner" id="btnSpinner"></div>
        </button>

        <div class="security-row">
          <div class="sec-item"><span>ğŸ”</span> SSL 256-bit</div>
          <div class="sec-item"><span>ğŸ›¡</span> 3D Secure</div>
          <div class="sec-item"><span>ğŸ”’</span> Paiement chiffrÃ©</div>
        </div>
      </div>
    </div>
  </div>
</div>

{# â•â•â• MODAL SUCCÃˆS + TÃ‰LÃ‰CHARGEMENT FACTURE â•â•â• #}
<div class="success-overlay" id="successOverlay">
  <div class="success-modal">

    <div class="success-hero">
      <div class="success-icon-ring">âœ“</div>
      <div class="success-title">Paiement acceptÃ© !</div>
      <div class="success-sub">Votre commande est confirmÃ©e et payÃ©e avec succÃ¨s.</div>
    </div>

    <div class="success-body">
      <div style="text-align:center; margin-bottom:16px;">
        <span class="paid-badge-big">âœ… Commande PAYÃ‰E</span>
      </div>

      <div class="success-recap">
        <div class="recap-row">
          <span class="recap-label">Commande</span>
          <span class="recap-value" id="successCommandeRef">â€”</span>
        </div>
        <div class="recap-row">
          <span class="recap-label">Date</span>
          <span class="recap-value" id="successDate">â€”</span>
        </div>
        <div class="recap-row">
          <span class="recap-label">Montant dÃ©bitÃ©</span>
          <span class="recap-value amount" id="successMontant">â€”</span>
        </div>
        <div class="recap-row">
          <span class="recap-label">Statut</span>
          <span class="recap-value" style="color:#10B981;">âœ“ PayÃ©e</span>
        </div>
      </div>

      <div class="success-actions">
        <a class="btn-download-pdf" id="btnDownloadFacture" href="#" target="_blank">
          ğŸ“„ TÃ©lÃ©charger la facture PDF
        </a>
        <button class="btn-later" onclick="closeSuccessAndReload()">
          Fermer et retourner Ã  mes commandes
        </button>
      </div>
    </div>

  </div>
</div>

{# Confetti container #}
<div class="confetti-container" id="confettiContainer"></div>

{% endblock %}

{% block javascripts %}
<script>
let currentCommandeId   = null;
let selectedBrand       = 'VISA';

// â•â• Ouverture modal paiement â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openPayModal(id, montant) {
  currentCommandeId = id;
  document.getElementById('modalRef').textContent     = '#' + id;
  document.getElementById('modalMontant').textContent = montant + ' TND';

  // Reset
  ['nomCarte','numeroCarte','cvv'].forEach(f => {
    const el  = document.getElementById(f);
    const err = document.getElementById('err-' + f);
    if (el)  { el.value = ''; el.classList.remove('is-error'); }
    if (err) { err.textContent = ''; err.classList.remove('show'); }
  });
  document.getElementById('expMois').value  = '';
  document.getElementById('expAnnee').value = '';
  ['expMois','expAnnee'].forEach(id => document.getElementById(id).classList.remove('is-error'));
  const expErr = document.getElementById('err-expiration');
  expErr.textContent = ''; expErr.classList.remove('show');

  const ge = document.getElementById('globalErr');
  ge.textContent = ''; ge.classList.remove('show');

  // Reset carte virtuelle
  document.getElementById('vcNumber').textContent = 'â€¢â€¢â€¢â€¢  â€¢â€¢â€¢â€¢  â€¢â€¢â€¢â€¢  â€¢â€¢â€¢â€¢';
  document.getElementById('vcName').textContent   = 'VOTRE NOM';
  document.getElementById('vcExp').textContent    = 'MM/AA';

  selectBrand(document.querySelector('.pm-option[data-brand="VISA"]'), 'VISA');

  document.getElementById('submitBtn').disabled      = false;
  document.getElementById('btnText').textContent     = 'ğŸ”’ Confirmer le paiement';
  document.getElementById('btnSpinner').style.display= 'none';

  document.getElementById('payModal').classList.add('open');
  setTimeout(() => document.getElementById('nomCarte').focus(), 150);
}

function closePayModal() {
  document.getElementById('payModal').classList.remove('open');
  currentCommandeId = null;
}

function handleOverlayClick(e) {
  if (e.target === document.getElementById('payModal')) closePayModal();
}

// â•â• SÃ©lection marque â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function selectBrand(el, brand) {
  document.querySelectorAll('.pm-option').forEach(o => o.classList.remove('selected'));
  if (el) el.classList.add('selected');
  selectedBrand = brand;
  document.getElementById('vcBrand').textContent = brand;
  const cvvInput = document.getElementById('cvv');
  cvvInput.placeholder = brand === 'AMEX' ? '4 chiffres (dos)' : '3 chiffres (dos)';
  cvvInput.maxLength   = brand === 'AMEX' ? 4 : 3;
}

// â•â• Carte virtuelle live â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateVcName(val) {
  document.getElementById('vcName').textContent = (val.trim().toUpperCase() || 'VOTRE NOM').substring(0, 22);
}
function updateVcExp() {
  const m = document.getElementById('expMois').value;
  const y = document.getElementById('expAnnee').value;
  document.getElementById('vcExp').textContent = (m && y) ? m + '/' + y : 'MM/AA';
}

// Formatage numÃ©ro
document.getElementById('numeroCarte').addEventListener('input', function() {
  const digits = this.value.replace(/\D/g,'').substring(0, 16);
  this.value   = digits.replace(/(.{4})/g,'$1 ').trim();
  const padded = digits.padEnd(16,'â€¢');
  document.getElementById('vcNumber').textContent =
    padded.slice(0,4)+'  '+padded.slice(4,8)+'  '+padded.slice(8,12)+'  '+padded.slice(12,16);
});

document.getElementById('cvv').addEventListener('input', function() {
  this.value = this.value.replace(/\D/g,'').substring(0, selectedBrand === 'AMEX' ? 4 : 3);
});

// â•â• Erreurs â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showErr(field, msg) {
  if (field === 'expiration') {
    ['expMois','expAnnee'].forEach(id => document.getElementById(id).classList.add('is-error'));
  } else {
    const inp = document.getElementById(field);
    if (inp) inp.classList.add('is-error');
  }
  const e = document.getElementById('err-' + field);
  if (e) { e.textContent = msg; e.classList.add('show'); }
}
function clearErr(field) {
  if (field === 'expiration') {
    ['expMois','expAnnee'].forEach(id => document.getElementById(id).classList.remove('is-error'));
  } else {
    const inp = document.getElementById(field);
    if (inp) inp.classList.remove('is-error');
  }
  const e = document.getElementById('err-' + field);
  if (e) { e.textContent = ''; e.classList.remove('show'); }
}

// â•â• Soumission â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function submitPaiement() {
  if (!currentCommandeId) return;

  ['nomCarte','numeroCarte','expiration','cvv'].forEach(clearErr);
  const ge = document.getElementById('globalErr');
  ge.textContent = ''; ge.classList.remove('show');

  const btn     = document.getElementById('submitBtn');
  const spinner = document.getElementById('btnSpinner');
  const btnText = document.getElementById('btnText');

  btn.disabled          = true;
  btnText.textContent   = 'Traitement en coursâ€¦';
  spinner.style.display = 'block';

  const mois       = document.getElementById('expMois').value;
  const annee      = document.getElementById('expAnnee').value;
  const expiration = (mois && annee) ? mois + '/' + annee : '';
  const nomCarte   = document.getElementById('nomCarte').value.trim();
  const numeroCarte= document.getElementById('numeroCarte').value.replace(/\s/g,'');
  const cvv        = document.getElementById('cvv').value.trim();

  try {
    const res  = await fetch(`/api/paiement/${currentCommandeId}/payer`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ nomCarte, numeroCarte, expiration, cvv })
    });
    const data = await res.json();
    spinner.style.display = 'none';

    if (res.ok) {
      // âœ… Fermer modal paiement
      closePayModal();
      // âœ… Ouvrir modal succÃ¨s avec les infos
      openSuccessModal(currentCommandeId || data.commandeId, data.montantTotal);

    } else if (res.status === 422 && data.errors) {
      data.errors.forEach(e => showErr(e.field, e.message));
      btn.disabled        = false;
      btnText.textContent = 'ğŸ”’ Confirmer le paiement';
    } else {
      ge.textContent = data.error || 'Une erreur est survenue.';
      ge.classList.add('show');
      btn.disabled        = false;
      btnText.textContent = 'ğŸ”’ Confirmer le paiement';
    }
  } catch (err) {
    spinner.style.display = 'none';
    ge.textContent        = 'Erreur rÃ©seau. VÃ©rifiez votre connexion.';
    ge.classList.add('show');
    btn.disabled        = false;
    btnText.textContent = 'ğŸ”’ Confirmer le paiement';
  }
}

// â•â• Modal SuccÃ¨s â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openSuccessModal(commandeId, montant) {
  const now = new Date();
  const dateStr = now.toLocaleDateString('fr-FR', {day:'2-digit', month:'2-digit', year:'numeric'})
                + ' Ã  ' + now.toLocaleTimeString('fr-FR', {hour:'2-digit', minute:'2-digit'});

  document.getElementById('successCommandeRef').textContent = '#' + commandeId;
  document.getElementById('successDate').textContent        = dateStr;
  document.getElementById('successMontant').textContent     = (montant || 'â€”') + ' TND';

  // Lien vers la facture PDF
  document.getElementById('btnDownloadFacture').href = '/patient/commandes/' + commandeId + '/facture';

  document.getElementById('successOverlay').classList.add('open');

  // ğŸ‰ Confetti
  launchConfetti();
}

function closeSuccessAndReload() {
  document.getElementById('successOverlay').classList.remove('open');
  document.getElementById('confettiContainer').innerHTML = '';
  window.location.reload();
}

// â•â• Confetti ğŸ‰ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function launchConfetti() {
  const container = document.getElementById('confettiContainer');
  container.innerHTML = '';
  const colors = ['#F82239','#2F60F5','#10B981','#F59E0B','#8B5CF6','#EC4899'];

  for (let i = 0; i < 60; i++) {
    const piece = document.createElement('div');
    piece.className = 'confetti-piece';
    piece.style.cssText = `
      left: ${Math.random() * 100}%;
      background: ${colors[Math.floor(Math.random() * colors.length)]};
      width: ${4 + Math.random() * 8}px;
      height: ${4 + Math.random() * 8}px;
      border-radius: ${Math.random() > .5 ? '50%' : '2px'};
      animation-duration: ${1.5 + Math.random() * 2}s;
      animation-delay: ${Math.random() * .8}s;
    `;
    container.appendChild(piece);
  }

  // Nettoyer aprÃ¨s l'animation
  setTimeout(() => { container.innerHTML = ''; }, 4000);
}

// â•â• Escape key â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') {
    closePayModal();
  }
});
</script>
{% endblock %}
